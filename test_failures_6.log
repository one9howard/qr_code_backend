============================= test session starts ==============================
platform linux -- Python 3.13.11, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python
cachedir: .pytest_cache
rootdir: /app
plugins: mock-3.15.1, cov-7.0.0, requests-mock-1.12.1
collecting ... collected 197 items

tests/test_admin_metrics.py::test_admin_metrics_page_loads PASSED        [  0%]
tests/test_admin_metrics.py::test_non_admin_cannot_access_metrics PASSED [  1%]
tests/test_admin_metrics.py::test_metrics_data_display ERROR             [  1%]
tests/test_agent_claiming_security.py::test_register_does_not_link_agent_before_verification PASSED [  2%]
tests/test_agent_claiming_security.py::test_login_unverified_does_not_link_agent PASSED [  2%]
tests/test_agent_claiming_security.py::test_verify_email_links_agent PASSED [  3%]
tests/test_agent_claiming_security.py::test_submit_cannot_claim_other_email PASSED [  3%]
tests/test_agent_claiming_security.py::test_submit_blocked_when_agent_claimed_by_other_user FAILED [  4%]
tests/test_ai_readiness.py::TestAIReadiness::test_action_rejection FAILED [  4%]
tests/test_ai_readiness.py::TestAIReadiness::test_action_rejection ERROR [  4%]
tests/test_ai_readiness.py::TestAIReadiness::test_agent_action_lifecycle FAILED [  5%]
tests/test_ai_readiness.py::TestAIReadiness::test_app_event_schema_and_defaults FAILED [  5%]
tests/test_ai_readiness.py::TestAIReadiness::test_pii_stripping FAILED   [  6%]
tests/test_ai_readiness.py::TestAIReadiness::test_request_correlation SKIPPED [  6%]
tests/test_ai_readiness.py::TestAIReadiness::test_strict_allowlist FAILED [  7%]
tests/test_analytics.py::test_per_property_metrics_structure PASSED      [  7%]
tests/test_analytics.py::test_per_agent_rollup_structure PASSED          [  8%]
tests/test_config_boot.py::TestConfigStagingBoot::test_staging_boot_without_smtp FAILED [  8%]
tests/test_dashboard_ctas.py::test_progress_assign_next_step_points_to_dashboard_anchor PASSED [  9%]
tests/test_dashboard_smartsigns_phase1.py::TestSmartSignsPhase1::test_create_asset_always_unactivated PASSED [  9%]
tests/test_dashboard_smartsigns_phase1.py::TestSmartSignsPhase1::test_pro_user_cant_activate_without_order PASSED [ 10%]
tests/test_dependency_versions.py::TestDependencyVersions::test_flask_version_is_3x PASSED [ 10%]
tests/test_dependency_versions.py::TestDependencyVersions::test_werkzeug_version_is_3x PASSED [ 11%]
tests/test_dependency_versions.py::TestDependencyVersions::test_flask_werkzeug_compatible PASSED [ 11%]
tests/test_env_sanitization.py::TestGetEnvStr::test_strips_whitespace_by_default PASSED [ 12%]
tests/test_env_sanitization.py::TestGetEnvStr::test_preserves_whitespace_when_strip_false PASSED [ 12%]
tests/test_env_sanitization.py::TestGetEnvStr::test_returns_none_when_missing PASSED [ 13%]
tests/test_env_sanitization.py::TestGetEnvStr::test_returns_default_when_missing PASSED [ 13%]
tests/test_env_sanitization.py::TestGetEnvStr::test_returns_default_when_empty_after_strip PASSED [ 14%]
tests/test_env_sanitization.py::TestGetEnvStr::test_required_raises_on_missing PASSED [ 14%]
tests/test_env_sanitization.py::TestGetEnvStr::test_required_raises_on_empty_after_strip PASSED [ 15%]
tests/test_env_sanitization.py::TestGetEnvStr::test_required_passes_with_valid_value PASSED [ 15%]
tests/test_env_sanitization.py::TestGetEnvStr::test_stripe_webhook_secret_scenario PASSED [ 16%]
tests/test_events_csrf_exempt.py::test_events_endpoint_accepts_post_without_csrf PASSED [ 16%]
tests/test_events_csrf_exempt.py::test_events_blueprint_is_csrf_exempt_in_app PASSED [ 17%]
tests/test_events_csrf_runtime.py::test_events_csrf_exempt_code_inspection PASSED [ 17%]
tests/test_events_csrf_runtime.py::test_events_endpoint_returns_200_without_csrf PASSED [ 18%]
tests/test_feature_flows.py::test_lead_lifecycle 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! KeyboardInterrupt !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
/usr/local/lib/python3.13/encodings/utf_8.py:15: KeyboardInterrupt
(to show a full traceback on KeyboardInterrupt use --full-trace)
Traceback (most recent call last):
  File "<frozen runpy>", line 198, in _run_module_as_main
  File "<frozen runpy>", line 88, in _run_code
  File "/home/qrapp/.local/lib/python3.13/site-packages/pytest/__main__.py", line 9, in <module>
    raise SystemExit(pytest.console_main())
                     ~~~~~~~~~~~~~~~~~~~^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/config/__init__.py", line 223, in console_main
    code = main()
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/config/__init__.py", line 199, in main
    ret: ExitCode | int = config.hook.pytest_cmdline_main(config=config)
                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
           ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    raise exception
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    res = hook_impl.function(*args)
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/main.py", line 365, in pytest_cmdline_main
    return wrap_session(config, _main)
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/main.py", line 353, in wrap_session
    config.hook.pytest_sessionfinish(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        session=session, exitstatus=session.exitstatus
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
           ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    raise exception
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    teardown.throw(exception)
    ~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/logging.py", line 873, in pytest_sessionfinish
    return (yield)
            ^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    teardown.throw(exception)
    ~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/terminal.py", line 960, in pytest_sessionfinish
    result = yield
             ^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    teardown.throw(exception)
    ~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/warnings.py", line 118, in pytest_sessionfinish
    return (yield)
            ^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    res = hook_impl.function(*args)
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/runner.py", line 112, in pytest_sessionfinish
    session._setupstate.teardown_exact(None)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/runner.py", line 566, in teardown_exact
    raise exceptions[0]
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/runner.py", line 555, in teardown_exact
    fin()
    ~~~^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/fixtures.py", line 1053, in finish
    raise exceptions[0]
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/fixtures.py", line 1042, in finish
    fin()
    ~~~^^
  File "/home/qrapp/.local/lib/python3.13/site-packages/_pytest/fixtures.py", line 924, in _teardown_yield_fixture
    next(it)
    ~~~~^^^^
  File "/app/tests/conftest.py", line 42, in db_session
    conn.rollback()
    ~~~~~~~~~~~~~^^
  File "/app/database.py", line 59, in rollback
    self._conn.rollback()
    ~~~~~~~~~~~~~~~~~~~^^
psycopg2.OperationalError: no connection to the server

