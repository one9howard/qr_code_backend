<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ property.address }} | {{ property.agent_name }}</title>

    <!-- Core Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/property.css') }}">

    <!-- FontAwesome (if not already in style.css, assuming it is or similar icon lib is available. 
         Using text fallbacks if FA not present, but classes indicate intent) -->

    <!-- GATED Open Graph Tags -->
    <meta property="og:title" content="{{ property.address }}">
    <meta property="og:description"
        content="{{ property.beds }} Bed, {{ property.baths }} Bath | Listed by {{ property.agent_name }}">
    <meta property="og:url" content="{{ request.url }}">
    <meta name="twitter:card" content="summary_large_image">

    {# STRICT GATING: Only render OG Image if PAID #}
    {% if gating.is_paid and photos %}
    <meta property="og:image" content="{{ get_storage_url(photos[0]) }}">
    {% else %}
    {# Fallback generic image or nothing. Do NOT leak photo URL. #}
    {#
    <meta property="og:image" content="{{ url_for('static', filename='img/logo.png', _external=True) }}"> #}
    {% endif %}

</head>

<body class="property-page">

    <!-- 1. Global Close Action -->
    <a href="#" id="close-property" class="close-action" aria-label="Close">
        <span>&times;</span>
    </a>

    <!-- 2. Hero Section -->
    {% if gating.is_paid and photos %}
    <!-- PAID: Photo Hero -->
    <div class="hero-banner" style="background-image: url('{{ get_storage_url(photos[0]) }}');">
        <div class="hero-overlay"></div>
    </div>
    {% else %}
    <!-- FREE/EXPIRED: Locked Hero -->
    <div class="hero-banner locked">
        <div style="text-align: center; color: rgba(255,255,255,0.3);">
            <span style="font-size: 4rem;">üîí</span>
            {% if gating.is_expired %}
            <p>Listing Expired</p>
            {% else %}
            <p>Preview Mode</p>
            {% endif %}
        </div>
        <div class="hero-overlay"></div>
    </div>
    {% endif %}


    <!-- 3. Main Container -->
    <div class="property-container">

        <div class="property-grid">

            <!-- LEFT COLUMN: Content -->
            <div class="content-column">

                <!-- Main Header -->
                <div class="property-header-card">
                    <h1 class="property-title max-w-full break-words">{{ property.address }}</h1>

                    <div class="property-stats">
                        {% if gating.is_paid and property.price %}
                        <div class="stat-item" style="color: #fff; font-weight: bold; margin-right: 15px;">
                            {{ property.price }}
                        </div>
                        {% endif %}

                        <div class="stat-item">
                            <span>üõèÔ∏è {{ property.beds }} Beds</span>
                        </div>
                        <div class="stat-item">
                            <span>üõÅ {{ property.baths }} Baths</span>
                        </div>
                        {% if property.sqft %}
                        <div class="stat-item">
                            <span>üìê {{ property.sqft }} Sq Ft</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if open_house_mode %}
                    <div style="margin-top: 15px;">
                        <span class="badge"
                            style="background: #e74c3c; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem;">
                            Open House Check-In
                        </span>
                    </div>
                    {% endif %}
                </div>

                <!-- Gating Logic: Content View -->
                {% if gating.is_paid %}

                <!-- Description -->
                <div class="content-section">
                    <h3>About this Home</h3>
                    <div class="description-text">
                        {{ property.description or "No description provided." }}
                    </div>
                </div>

                <!-- Gallery -->
                {% if photos and photos|length > 1 %}
                <div class="content-section">
                    <h3>Gallery</h3>
                    <div class="gallery-grid">
                        {% for photo in photos[:6] %}
                        <img src="{{ get_storage_url(photo) }}" alt="Home Photo" loading="lazy"
                            onclick="alert('Full lightbox coming in Phase 2'); /* Placeholder for fancy lightbox */">
                        {% endfor %}
                    </div>
                    {% if photos|length > 6 %}
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn-outline" style="width: 100%;">View All {{ photos|length }} Photos</button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% else %}

                <!-- LOCKED Message -->
                <div class="locked-notification">
                    <h3 style="color: #ffc107; margin-bottom: 15px;">üîí Listing Content Locked</h3>
                    <p style="color: #ccc; margin-bottom: 25px;">
                        This listing is currently in <strong>{{ "Expired" if gating.is_expired else "Free" }}
                            Mode</strong>.
                        Photos and detailed description are hidden.
                    </p>

                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <a href="{{ url_for('dashboard.index') }}" class="btn-primary">
                            Owner Dashboard
                        </a>
                    </div>
                </div>

                {% endif %}

                <!-- Content End -->
                <div style="height: 50px;"></div>
            </div>


            <!-- RIGHT COLUMN: Sticky Rail (Desktop Only via CSS) -->
            <div class="sticky-rail">
                <div class="agent-card">
                    {% if property.agent_photo %}
                    {# Securely render agent photo - these are public usually #}
                    <img src="{{ get_storage_url(property.agent_photo) }}" class="agent-photo"
                        alt="{{ property.agent_name }}">
                    {% else %}
                    <div class="agent-photo"
                        style="background: #333; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        üë§
                    </div>
                    {% endif %}

                    <h3>{{ property.agent_name }}</h3>
                    <div class="brokerage">{{ property.brokerage }}</div>

                    <div class="agent-actions" id="agent-contact-section">
                        <button class="btn-primary trigger-lead-modal" style="width: 100%;">
                            Request Info
                        </button>

                        {% if property.agent_phone %}
                        <a href="tel:{{ property.agent_phone }}" class="btn-secondary" style="width: 100%;">
                            Call Agent
                        </a>
                        {% endif %}

                        <a href="mailto:{{ property.agent_email }}" class="btn-outline" style="width: 100%;">
                            Email Agent
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- 4. Mobile Action Bar (Fixed Bottom) -->
    <div class="mobile-action-bar">
        <div style="display: flex; align-items: center; gap: 10px;">
            {% if property.agent_photo %}
            <img src="{{ get_storage_url(property.agent_photo) }}"
                style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #4facfe;">
            {% endif %}
            <div style="font-size: 0.9rem; line-height: 1.2;">
                <div style="color: white; font-weight: bold;">{{ property.agent_name }}</div>
                <div
                    style="color: #888; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">
                    {{ property.brokerage }}
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; flex: 1; justify-content: flex-end;">
            {% if property.agent_phone %}
            <a href="tel:{{ property.agent_phone }}" class="mobile-contact-btn secondary" style="flex: 0 0 50px;"
                aria-label="Call">
                üìû
            </a>
            {% endif %}
            <button class="mobile-contact-btn primary trigger-lead-modal" style="flex: 1; max-width: 150px;">
                Contact
            </button>
        </div>
    </div>


    <!-- 5. Lead Generation Modal -->
    <div id="lead-modal" class="lead-modal">
        <div class="lead-modal-content">
            <span class="close-modal-x" onclick="closeLeadModal()">&times;</span>

            <h2 style="color: white; margin-bottom: 20px; font-size: 1.5rem;">Contact {{ property.agent_name }}</h2>

            <form id="lead-form" onsubmit="submitLeadForm(event)">
                <input type="hidden" name="property_id" value="{{ property.id }}">

                <!-- Honeypot -->
                <div style="display: none;">
                    <input type="text" name="website" id="website" tabindex="-1" autocomplete="off">
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="text" name="buyer_name" placeholder="Your Name" required
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(255,255,255,0.05); color: white;">
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="email" name="buyer_email" placeholder="Your Email" required
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(255,255,255,0.05); color: white;">
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="tel" name="buyer_phone" placeholder="Phone Number"
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(255,255,255,0.05); color: white;">
                </div>

                <div style="margin-bottom: 15px;">
                    <select name="preferred_contact"
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(255,255,255,0.05); color: white;">
                        <option value="email">Prefer Email</option>
                        <option value="text">Prefer Text</option>
                        <option value="call">Prefer Call</option>
                    </select>
                </div>

                <!-- Hidden inputs for simplicty, can add back if needed -->
                <input type="hidden" name="best_time" value="">

                <div style="margin-bottom: 15px;">
                    <textarea name="message" rows="3" placeholder="I'm interested in..."
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(255,255,255,0.05); color: white;"></textarea>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <input type="checkbox" id="consent" name="consent" required style="width: 20px; height: 20px;">
                    <label for="consent" style="font-size: 0.8rem; color: #aaa; line-height: 1.3;">
                        I agree to be contacted by {{ property.agent_name }} regarding this property.
                    </label>
                </div>

                <div id="lead-form-error" style="color: #ff6b6b; margin-bottom: 10px; display: none;"></div>
                <div id="lead-form-success" style="color: #2ed573; margin-bottom: 10px; display: none;"></div>

                <button type="submit" id="lead-submit-btn" class="btn-primary"
                    style="width: 100%; padding: 15px; font-size: 1.1rem;">
                    Send Request
                </button>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/pages/property.js') }}"></script>

</body>

</html>