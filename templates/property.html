<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    {# SEO Title: Address | Beds/Baths | CTA #}
    <title>{{ property.address or 'Property' }} | {{ property.beds }} bd {{ property.baths }} ba | Request info</title>

    {# Core Styles #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/property.css') }}">

    {# ============================================================
    OG / META TAGS - IN HEAD ONLY

    GATING RULE: og:image ONLY renders for PAID listings with photos.
    FREE/EXPIRED must NOT leak any photo URLs.
    ============================================================ #}
    <meta property="og:title" content="{{ property.address }}">
    <meta property="og:description"
        content="{{ property.beds }} Bed, {{ property.baths }} Bath{% if property.sqft %} ¬∑ {{ property.sqft }} sqft{% endif %} | Listed by {{ property.agent_name }}">
    <meta property="og:url" content="{{ request.url }}">
    <meta name="twitter:card" content="summary_large_image">

    {% if gating.is_paid and photos %}
    <meta property="og:image" content="{{ get_storage_url(photos[0]) }}">
    {% endif %}
    {# NO og:image for FREE/EXPIRED - intentionally omitted to prevent photo leakage #}
</head>

<body class="property-page"
    data-tier="{{ 'paid' if gating.is_paid else ('expired' if gating.is_expired else 'free') }}">

    {# ============================================================
    PHOTO LEAKAGE PREVENTION RULE (DO NOT REMOVE THIS COMMENT)

    ABSOLUTE REQUIREMENT: In FREE and EXPIRED states:
    - ZERO real listing photo URLs anywhere in rendered HTML
    - NO get_storage_url(photo) calls for listing photos
    - NO style="background-image: url(...)" with photo URLs
    - NO photos array embedded in JavaScript
    - NO og:image pointing to listing photos

    Agent headshots ARE allowed (they are not listing content).
    Photo COUNT as plain text is allowed (e.g., "28 photos").

    Any code that renders photos MUST be wrapped in:
    {% if gating.is_paid and photos %}...{% endif %}
    ============================================================ #}

    {# ============ TOPBAR ============ #}
    <header class="property-topbar">
        <button type="button" id="close-property" class="topbar-close" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
            </svg>
        </button>
        <span class="topbar-brand">InSite Signs</span>
    </header>

    {# ============ HERO SECTION ============ #}
    <section class="hero">
        {% if gating.is_paid and photos %}
        {# PAID: Photo hero with thumbnails #}
        <div class="hero-main" id="hero-main">
            <img src="{{ get_storage_url(photos[0]) }}" alt="{{ property.address }}" class="hero-image" id="hero-image">
            <button type="button" class="hero-photo-count" id="open-lightbox">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M4 4h7V2H4c-1.1 0-2 .9-2 2v7h2V4zm6 9l-4 5h12l-3-4-2.03 2.71L10 13zm7-4.5c0-.83-.67-1.5-1.5-1.5S14 7.67 14 8.5s.67 1.5 1.5 1.5S17 9.33 17 8.5zM20 2h-7v2h7v7h2V4c0-1.1-.9-2-2-2zm0 18h-7v2h7c1.1 0 2-.9 2-2v-7h-2v7zM4 13H2v7c0 1.1.9 2 2 2h7v-2H4v-7z" />
                </svg>
                {{ photos|length }} Photos
            </button>
        </div>
        {% if photos|length > 1 %}
        <div class="hero-thumbnails">
            {% for photo in photos[:5] %}
            <button type="button" class="thumb-btn" data-index="{{ loop.index0 }}">
                <img src="{{ get_storage_url(photo) }}" alt="Photo {{ loop.index }}" loading="lazy">
            </button>
            {% endfor %}
            {% if photos|length > 5 %}
            <button type="button" class="thumb-btn thumb-more" id="open-lightbox-more">
                +{{ photos|length - 5 }}
            </button>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        {# FREE/EXPIRED: Locked hero - NO photo URLs #}
        <div class="hero-locked">
            <div class="hero-lock-icon">üîí</div>
            {% if gating.is_expired %}
            <p class="hero-lock-text">Listing Expired</p>
            {% else %}
            <p class="hero-lock-text">Listing Preview Locked</p>
            {% if photos %}
            <p class="hero-lock-count">{{ photos|length }} photos available</p>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}

        {# Facts Overlay - Always shown #}
        <div class="hero-facts">
            <h1 class="facts-address">{{ property.address }}</h1>
            <div class="facts-row">
                {% if gating.is_paid and property.price %}
                <span class="facts-price">{{ property.price }}</span>
                {% endif %}
                <span class="facts-stat">{{ property.beds }} bd</span>
                <span class="facts-divider">|</span>
                <span class="facts-stat">{{ property.baths }} ba</span>
                {% if property.sqft %}
                <span class="facts-divider">|</span>
                <span class="facts-stat">{{ property.sqft }} sqft</span>
                {% endif %}
            </div>
            <div class="facts-badges">
                {% if open_house_mode %}
                <span class="badge badge-openhouse">Open House</span>
                {% endif %}
                {% if gating.is_expired %}
                <span class="badge badge-expired">Expired</span>
                {% elif not gating.is_paid %}
                <span class="badge badge-locked">Preview</span>
                {% endif %}
            </div>
        </div>
    </section>

    {# ============ MAIN LAYOUT ============ #}
    <main class="property-main">
        <div class="property-grid">

            {# LEFT COLUMN: Content #}
            <div class="content-column">

                {# About Section #}
                <section class="content-section" id="about-section">
                    <h2 class="section-title">About this home</h2>
                    {% if gating.is_paid %}
                    <div class="description-text">
                        {{ property.description or "No description provided." }}
                    </div>
                    {% elif gating.is_expired %}
                    <div class="description-expired">
                        <p>This listing is no longer active. Contact the agent for current availability or similar
                            properties.</p>
                    </div>
                    {% else %}
                    {# FREE: Teaser with expand trigger #}
                    <div class="description-teaser">
                        <p class="teaser-text">{{ (property.description or "")[:250] }}{% if property.description and
                            property.description|length > 250 %}...{% endif %}</p>
                        {% if property.description and property.description|length > 250 %}
                        <button type="button" class="continue-reading" data-trigger="continue_reading">
                            Continue reading
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </section>

                {# Highlights / Features Section #}
                {% if property.beds or property.baths or property.sqft %}
                <section class="content-section" id="highlights-section">
                    <h2 class="section-title">Highlights</h2>
                    <div class="feature-chips">
                        {% if property.beds %}
                        <span class="chip">üõèÔ∏è {{ property.beds }} Bedrooms</span>
                        {% endif %}
                        {% if property.baths %}
                        <span class="chip">üõÅ {{ property.baths }} Bathrooms</span>
                        {% endif %}
                        {% if property.sqft %}
                        <span class="chip">üìê {{ property.sqft }} sq ft</span>
                        {% endif %}
                        {% if property.property_type %}
                        <span class="chip">üè† {{ property.property_type }}</span>
                        {% endif %}
                        {% if property.year_built %}
                        <span class="chip">üìÖ Built {{ property.year_built }}</span>
                        {% endif %}
                        {% if property.lot_size %}
                        <span class="chip">üå≥ {{ property.lot_size }} lot</span>
                        {% endif %}
                    </div>
                </section>
                {% endif %}

                {# Gallery Section #}
                <section class="content-section" id="gallery-section">
                    <h2 class="section-title">Photos</h2>
                    {% if gating.is_paid and photos %}
                    {# PAID: Render gallery grid #}
                    <div class="gallery-grid">
                        {% for photo in photos[:12] %}
                        <button type="button" class="gallery-item" data-index="{{ loop.index0 }}">
                            <img src="{{ get_storage_url(photo) }}" alt="Photo {{ loop.index }}" loading="lazy">
                        </button>
                        {% endfor %}
                    </div>
                    {% if photos|length > 12 %}
                    <button type="button" class="btn-outline view-all-photos" id="view-all-photos">
                        View all {{ photos|length }} photos
                    </button>
                    {% endif %}

                    {% else %}
                    {# FREE/EXPIRED: Locked gallery card - NO photo URLs #}
                    <div class="gallery-locked" data-trigger="click_gallery">
                        <div class="lock-icon">üîí</div>
                        <p class="lock-title">Photos locked</p>
                        {% if photos %}
                        <p class="lock-count">{{ photos|length }} photos available with full listing</p>
                        {% endif %}
                        <button type="button" class="btn-unlock" data-trigger="click_gallery">
                            Unlock photos
                        </button>
                    </div>
                    {% endif %}
                </section>

                {# Open House / Tour Request #}
                {% if open_house_mode or True %}
                <section class="content-section" id="tour-section">
                    <h2 class="section-title">Schedule a tour</h2>
                    <p class="tour-text">Interested in seeing this property in person?</p>
                    <button type="button" class="btn-primary btn-tour" id="request-tour">
                        Request a tour
                    </button>
                </section>
                {% endif %}

                {# Spacer for mobile action bar #}
                <div class="mobile-spacer"></div>
            </div>

            {# RIGHT COLUMN: Sticky Agent Rail (Desktop) #}
            <aside class="agent-rail" id="agent-rail">
                <div class="agent-card">
                    {% if property.agent_photo %}
                    <img src="{{ get_storage_url(property.agent_photo) }}" class="agent-photo"
                        alt="{{ property.agent_name }}">
                    {% else %}
                    <div class="agent-photo agent-photo-placeholder">{{ property.agent_name[0] }}</div>
                    {% endif %}
                    <h3 class="agent-name">{{ property.agent_name }}</h3>
                    <p class="agent-brokerage">{{ property.brokerage }}</p>

                    <button type="button" class="btn-primary btn-request-info" id="scroll-to-form-btn">
                        Request info
                    </button>

                    <form id="lead-form" class="lead-form" autocomplete="on">
                        <input type="hidden" name="property_id" value="{{ property.id }}">
                        <input type="hidden" name="request_type" id="request_type" value="info">

                        {# Honeypot #}
                        <div class="hp-field">
                            <input type="text" name="website" id="website" tabindex="-1" autocomplete="off">
                        </div>

                        <div class="form-group">
                            <input type="text" name="buyer_name" id="buyer_name" placeholder="Your name" required
                                class="form-input">
                        </div>
                        <div class="form-group">
                            <input type="email" name="buyer_email" id="buyer_email" placeholder="Email" required
                                class="form-input">
                        </div>
                        <div class="form-group">
                            <input type="tel" name="buyer_phone" id="buyer_phone" placeholder="Phone"
                                class="form-input">
                        </div>

                        {# Collapsible message #}
                        <div class="form-group message-toggle">
                            <button type="button" class="toggle-message" id="toggle-message">
                                + Add a message
                            </button>
                        </div>
                        <div class="form-group message-field" id="message-field" style="display: none;">
                            <textarea name="message" id="message" placeholder="I'm interested in..." rows="3"
                                class="form-input"></textarea>
                        </div>

                        <input type="hidden" name="preferred_contact" value="email">
                        <input type="hidden" name="best_time" value="">

                        <div class="form-group consent-group">
                            <label class="consent-label">
                                <input type="checkbox" name="consent" id="consent" required>
                                <span>I agree to be contacted by {{ property.agent_name }} regarding this
                                    property.</span>
                            </label>
                        </div>

                        <div id="lead-form-error" class="form-error"></div>
                        <div id="lead-form-success" class="form-success"></div>

                        <button type="submit" id="lead-submit-btn" class="btn-primary btn-submit">
                            Send request
                        </button>
                    </form>

                    {# Secondary actions #}
                    <div class="agent-actions">
                        {% if property.agent_phone %}
                        <a href="tel:{{ property.agent_phone }}" class="btn-secondary btn-call" data-action="call">
                            üìû Call
                        </a>
                        {% endif %}
                        <a href="mailto:{{ property.agent_email }}" class="btn-outline btn-email" data-action="email">
                            ‚úâÔ∏è Email
                        </a>
                    </div>
                </div>
            </aside>

        </div>
    </main>

    {# ============ MOBILE ACTION BAR (Fixed Bottom) ============ #}
    <div class="mobile-action-bar" id="mobile-action-bar">
        {% if property.agent_phone %}
        <a href="tel:{{ property.agent_phone }}" class="mobile-btn mobile-btn-call" data-action="call">
            üìû<span>Call</span>
        </a>
        {% endif %}
        <button type="button" class="mobile-btn mobile-btn-info" id="mobile-request-info" data-action="request_info">
            üí¨<span>Request info</span>
        </button>
        <a href="mailto:{{ property.agent_email }}" class="mobile-btn mobile-btn-email" data-action="email">
            ‚úâÔ∏è<span>Email</span>
        </a>
    </div>

    {# ============ LIGHTBOX (PAID only, built by JS) ============ #}
    <div id="lightbox" class="lightbox" style="display: none;">
        <button type="button" class="lightbox-close" id="lightbox-close">&times;</button>
        <button type="button" class="lightbox-nav lightbox-prev" id="lightbox-prev">&lt;</button>
        <div class="lightbox-content">
            <img src="" alt="Property photo" id="lightbox-img">
            <div class="lightbox-counter" id="lightbox-counter"></div>
        </div>
        <button type="button" class="lightbox-nav lightbox-next" id="lightbox-next">&gt;</button>
    </div>

    {# ============ UPSELL SHEET (For FREE/EXPIRED gated content - ONLY for photos/description) ============ #}
    <div id="upsell-sheet" class="upsell-sheet" style="display: none;">
        <div class="upsell-backdrop" id="upsell-backdrop"></div>
        <div class="upsell-content">
            <button type="button" class="upsell-close" id="upsell-close">&times;</button>
            <div class="upsell-icon">üîí</div>
            <h3 class="upsell-title">Unlock full listing</h3>
            <p class="upsell-text">Photos and full description are available with the complete listing. Contact the
                agent for access.</p>
            <button type="button" class="btn-primary upsell-cta" id="upsell-contact">
                Contact agent
            </button>
        </div>
    </div>

    {# ============ MOBILE LEAD MODAL (Always accessible - lead capture must NOT be blocked) ============ #}
    <div id="mobile-lead-modal" class="lead-modal" style="display: none;">
        <div class="lead-modal-backdrop" id="mobile-lead-backdrop"></div>
        <div class="lead-modal-content">
            <button type="button" class="modal-close" id="mobile-lead-close">&times;</button>
            <h2 class="modal-title">Contact {{ property.agent_name }}</h2>

            <form id="mobile-lead-form" class="lead-form" autocomplete="on">
                <input type="hidden" name="property_id" value="{{ property.id }}">
                <input type="hidden" name="request_type" id="mobile_request_type" value="info">

                {# Honeypot #}
                <div class="hp-field">
                    <input type="text" name="website" tabindex="-1" autocomplete="off">
                </div>

                <div class="form-group">
                    <input type="text" name="buyer_name" placeholder="Your name" required class="form-input">
                </div>
                <div class="form-group">
                    <input type="email" name="buyer_email" placeholder="Email" required class="form-input">
                </div>
                <div class="form-group">
                    <input type="tel" name="buyer_phone" placeholder="Phone" class="form-input">
                </div>
                <div class="form-group">
                    <textarea name="message" placeholder="I'm interested in..." rows="3" class="form-input"></textarea>
                </div>

                <input type="hidden" name="preferred_contact" value="email">
                <input type="hidden" name="best_time" value="">

                <div class="form-group consent-group">
                    <label class="consent-label">
                        <input type="checkbox" name="consent" required>
                        <span>I agree to be contacted by {{ property.agent_name }} regarding this property.</span>
                    </label>
                </div>

                <div id="mobile-lead-error" class="form-error"></div>
                <div id="mobile-lead-success" class="form-success"></div>

                <button type="submit" id="mobile-lead-submit" class="btn-primary btn-submit">
                    Send request
                </button>
            </form>
        </div>
    </div>

    {# ============ SCRIPTS ============ #}
    {# Pass minimal server data to JS - Safe Injection #}
    <script>
        try {
            window.PROPERTY_DATA = {
                id: "{{ property.id }}",
                tier: "{{ 'paid' if gating.is_paid else ('expired' if gating.is_expired else 'free') }}",
                photos: [],
                photoCount: 0,
                agentName: "{{ property.agent_name|e }}"
            

            {% if gating.is_paid and photos %}
            // Inject photos one by one to avoid syntax errors
            {% for p in photos %}
            window.PROPERTY_DATA.photos.push("{{ get_storage_url(p) }}");
            {% endfor %}

            window.PROPERTY_DATA.photoCount = window.PROPERTY_DATA.photos.length;
            {% else %}
            window.PROPERTY_DATA.photoCount = {{ photos|length }
        
        {% endif %}

        } catch (e) {
            console.error('Data Injection Error [Fixed]', e);
            // Fallback for safety
            if (!window.PROPERTY_DATA) window.PROPERTY_DATA = { photos: [] 
        }
    </script>
    <script src="{{ url_for('static', filename='js/pages/property.js') }}" defer></script>

</body>

</html>
