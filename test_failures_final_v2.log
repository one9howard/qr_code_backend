============================= test session starts ==============================
platform linux -- Python 3.13.11, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python
cachedir: .pytest_cache
rootdir: /app
plugins: mock-3.15.1, cov-7.0.0, requests-mock-1.12.1
collecting ... collected 197 items

tests/test_admin_metrics.py::test_admin_metrics_page_loads PASSED        [  0%]
tests/test_admin_metrics.py::test_non_admin_cannot_access_metrics PASSED [  1%]
tests/test_admin_metrics.py::test_metrics_data_display ERROR             [  1%]
tests/test_agent_claiming_security.py::test_register_does_not_link_agent_before_verification PASSED [  2%]
tests/test_agent_claiming_security.py::test_login_unverified_does_not_link_agent PASSED [  2%]
tests/test_agent_claiming_security.py::test_verify_email_links_agent PASSED [  3%]
tests/test_agent_claiming_security.py::test_submit_cannot_claim_other_email PASSED [  3%]
tests/test_agent_claiming_security.py::test_submit_blocked_when_agent_claimed_by_other_user FAILED [  4%]
tests/test_ai_readiness.py::TestAIReadiness::test_action_rejection PASSED [  4%]
tests/test_ai_readiness.py::TestAIReadiness::test_agent_action_lifecycle FAILED [  5%]
tests/test_ai_readiness.py::TestAIReadiness::test_app_event_schema_and_defaults PASSED [  5%]
tests/test_ai_readiness.py::TestAIReadiness::test_pii_stripping PASSED   [  6%]
tests/test_ai_readiness.py::TestAIReadiness::test_request_correlation SKIPPED [  6%]
tests/test_ai_readiness.py::TestAIReadiness::test_strict_allowlist PASSED [  7%]
tests/test_analytics.py::test_per_property_metrics_structure PASSED      [  7%]
tests/test_analytics.py::test_per_agent_rollup_structure PASSED          [  8%]
tests/test_config_boot.py::TestConfigStagingBoot::test_staging_boot_without_smtp FAILED [  8%]
tests/test_dashboard_ctas.py::test_progress_assign_next_step_points_to_dashboard_anchor PASSED [  9%]
tests/test_dashboard_smartsigns_phase1.py::TestSmartSignsPhase1::test_create_asset_always_unactivated PASSED [  9%]
tests/test_dashboard_smartsigns_phase1.py::TestSmartSignsPhase1::test_pro_user_cant_activate_without_order PASSED [ 10%]
tests/test_dependency_versions.py::TestDependencyVersions::test_flask_version_is_3x PASSED [ 10%]
tests/test_dependency_versions.py::TestDependencyVersions::test_werkzeug_version_is_3x PASSED [ 11%]
tests/test_dependency_versions.py::TestDependencyVersions::test_flask_werkzeug_compatible PASSED [ 11%]
tests/test_env_sanitization.py::TestGetEnvStr::test_strips_whitespace_by_default PASSED [ 12%]
tests/test_env_sanitization.py::TestGetEnvStr::test_preserves_whitespace_when_strip_false PASSED [ 12%]
tests/test_env_sanitization.py::TestGetEnvStr::test_returns_none_when_missing PASSED [ 13%]
tests/test_env_sanitization.py::TestGetEnvStr::test_returns_default_when_missing PASSED [ 13%]
tests/test_env_sanitization.py::TestGetEnvStr::test_returns_default_when_empty_after_strip PASSED [ 14%]
tests/test_env_sanitization.py::TestGetEnvStr::test_required_raises_on_missing PASSED [ 14%]
tests/test_env_sanitization.py::TestGetEnvStr::test_required_raises_on_empty_after_strip PASSED [ 15%]
tests/test_env_sanitization.py::TestGetEnvStr::test_required_passes_with_valid_value PASSED [ 15%]
tests/test_env_sanitization.py::TestGetEnvStr::test_stripe_webhook_secret_scenario PASSED [ 16%]
tests/test_events_csrf_exempt.py::test_events_endpoint_accepts_post_without_csrf PASSED [ 16%]
tests/test_events_csrf_exempt.py::test_events_blueprint_is_csrf_exempt_in_app PASSED [ 17%]
tests/test_events_csrf_runtime.py::test_events_csrf_exempt_code_inspection PASSED [ 17%]
tests/test_events_csrf_runtime.py::test_events_endpoint_returns_200_without_csrf PASSED [ 18%]
tests/test_feature_flows.py::test_lead_lifecycle FAILED                  [ 18%]
tests/test_feature_flows.py::test_qr_variant_resolution PASSED           [ 19%]
tests/test_feature_flows.py::test_open_house_mode ERROR                  [ 19%]
tests/test_feature_flows.py::test_gating_rendering ERROR                 [ 20%]
tests/test_feature_flows.py::test_cleanup_calls_storage_delete PASSED    [ 20%]
tests/test_fix_cleanup.py::test_smart_riser_webhook_behavior PASSED      [ 21%]
tests/test_fix_cleanup.py::test_admin_drift_grep PASSED                  [ 21%]
tests/test_free_property.py::test_new_property_get ERROR                 [ 22%]
tests/test_free_property.py::test_new_property_post_success ERROR        [ 22%]
tests/test_free_property.py::test_new_property_post_free_limit ERROR     [ 23%]
tests/test_fulfillment.py::test_fulfill_order_enqueues_one_print_job FAILED [ 23%]
tests/test_fulfillment.py::test_fulfill_order_idempotency FAILED         [ 24%]
tests/test_global_code_generation_enforcement.py::test_property_creation_uses_global_generator FAILED [ 24%]
tests/test_global_code_generation_enforcement.py::test_variant_creation_uses_global_generator FAILED [ 25%]
tests/test_guest_linking_security.py::test_guest_linking_security FAILED [ 25%]
tests/test_guest_security.py::test_guest_resize_with_body_token FAILED   [ 26%]
tests/test_guest_security.py::test_billing_unverified_access FAILED      [ 26%]
tests/test_guest_security.py::test_branding_csrf_protection PASSED       [ 27%]
tests/test_import.py::test_import_listing PASSED                         [ 27%]
tests/test_import.py::test_import_smart PASSED                           [ 28%]
tests/test_import.py::test_import_validation PASSED                      [ 28%]
tests/test_lead_attribution.py::TestAttribToken::test_make_verify_token_roundtrip PASSED [ 29%]
tests/test_lead_attribution.py::TestAttribToken::test_expired_token_rejected PASSED [ 29%]
tests/test_lead_attribution.py::TestAttribToken::test_forged_signature_rejected PASSED [ 30%]
tests/test_lead_attribution.py::TestAttribToken::test_forged_asset_id_rejected PASSED [ 30%]
tests/test_lead_attribution.py::TestAttribToken::test_invalid_token_formats PASSED [ 31%]
tests/test_lead_attribution.py::TestLeadValidation::test_lead_with_email_only PASSED [ 31%]
tests/test_lead_attribution.py::TestLeadValidation::test_lead_with_phone_only FAILED [ 32%]
tests/test_lead_attribution.py::TestLeadValidation::test_lead_without_contact_fails PASSED [ 32%]
tests/test_lead_attribution.py::TestAttributionCookie::test_cookie_set_on_assigned_smartsign SKIPPED [ 33%]
tests/test_lead_attribution.py::TestAttributionCookie::test_cookie_not_set_on_unassigned_smartsign SKIPPED [ 34%]
tests/test_lead_attribution.py::TestLeadAttribution::test_lead_attributed_with_valid_token SKIPPED [ 34%]
tests/test_lead_attribution.py::TestLeadAttribution::test_forged_token_ignored FAILED [ 35%]
tests/test_listing_kits_imports.py::test_listing_kits_import PASSED      [ 35%]
tests/test_listing_kits_imports.py::test_kit_zip_builder_structure FAILED [ 36%]
tests/test_local_storage_security.py::TestLocalStorageSecurity::test_path_traversal_with_dotdot_raises_error PASSED [ 36%]
tests/test_local_storage_security.py::TestLocalStorageSecurity::test_path_traversal_with_absolute_path_raises_error PASSED [ 37%]
tests/test_local_storage_security.py::TestLocalStorageSecurity::test_normal_paths_work_correctly PASSED [ 37%]
tests/test_local_storage_security.py::TestLocalStorageSecurity::test_get_url_returns_storage_path FAILED [ 38%]
tests/test_local_storage_security.py::TestLocalStorageSecurity::test_put_and_get_with_safe_path PASSED [ 38%]
tests/test_local_storage_security.py::TestLocalStorageSecurity::test_get_file_with_traversal_raises PASSED [ 39%]
tests/test_notifications_skipped.py::TestNotificationSkipped::test_notification_returns_skipped_without_smtp PASSED [ 39%]
tests/test_notifications_skipped.py::TestNotificationSkipped::test_notification_tuple_has_three_elements PASSED [ 40%]
tests/test_onboarding_activation.py::TestPhase1Dashboard::test_dashboard_mode_no_signs FAILED [ 40%]
tests/test_onboarding_activation.py::TestPhase1Dashboard::test_dashboard_mode_needs_assignment ERROR [ 41%]
tests/test_onboarding_activation.py::TestPhase1Dashboard::test_dashboard_mode_active ERROR [ 41%]
tests/test_onboarding_activation.py::TestPhase1Dashboard::test_progress_percent_stages PASSED [ 42%]
tests/test_onboarding_activation.py::TestPhase1Dashboard::test_first_scan_banner ERROR [ 42%]
tests/test_onboarding_activation.py::TestPhase1Dashboard::test_first_lead_banner ERROR [ 43%]
tests/test_onboarding_activation.py::TestPhase1Dashboard::test_analytics_gated_until_scan ERROR [ 43%]
tests/test_pdf_security.py::TestResolvePdfPath::test_allows_valid_order_path_format PASSED [ 44%]
tests/test_pdf_security.py::TestResolvePdfPath::test_blocks_absolute_paths PASSED [ 44%]
tests/test_pdf_security.py::TestResolvePdfPath::test_blocks_leading_slash PASSED [ 45%]
tests/test_pdf_security.py::TestResolvePdfPath::test_blocks_path_traversal PASSED [ 45%]
tests/test_pdf_security.py::TestResolvePdfPath::test_empty_and_none_input PASSED [ 46%]
tests/test_pdf_security.py::TestResolvePdfPath::test_rejects_invalid_order_id_format PASSED [ 46%]
tests/test_pdf_security.py::TestPrivatePdfPaths::test_get_private_pdf_path_format PASSED [ 47%]
tests/test_pdf_security.py::TestPrivatePdfPaths::test_get_private_pdf_relative_path_format PASSED [ 47%]
tests/test_pdf_security.py::TestPaidStatuses::test_paid_statuses_contains_expected_values PASSED [ 48%]
tests/test_pdf_vector_qr.py::test_pdf_vector_qr_no_embedded_images PASSED [ 48%]
tests/test_pdf_vector_qr.py::test_pdf_vector_qr_all_sizes PASSED         [ 49%]
tests/test_pdf_vector_qr.py::test_pdf_with_agent_photo_has_one_image FAILED [ 49%]
tests/test_phase4_guardrails.py::test_free_user_cannot_create_second_property FAILED [ 50%]
tests/test_phase4_guardrails.py::test_pro_user_can_create_multiple_properties FAILED [ 50%]
tests/test_phase4_guardrails.py::test_reassign_requires_pro FAILED       [ 51%]
tests/test_phase4_guardrails.py::test_reassign_requires_activated FAILED [ 51%]
tests/test_phase4_guardrails.py::test_reassign_blocked_when_frozen FAILED [ 52%]
tests/test_phase4_guardrails.py::test_listing_kit_returns_reason_code FAILED [ 52%]
tests/test_phase_2_5.py::test_webhook_idempotency_activation FAILED      [ 53%]
tests/test_phase_2_5.py::test_assignment_rules FAILED                    [ 53%]
tests/test_phase_2_5.py::test_smart_sign_checkout_endpoint_disabled FAILED [ 54%]
tests/test_placeholder.py::test_release_placeholder PASSED               [ 54%]
tests/test_print_jobs.py::test_claim_jobs_is_idempotent PASSED           [ 55%]
tests/test_print_jobs.py::test_download_pdf_requires_auth_and_returns_bytes PASSED [ 55%]
tests/test_print_preflight.py::test_validate_sign_layout_success PASSED  [ 56%]
tests/test_print_preflight.py::test_validate_sign_layout_too_small_qr PASSED [ 56%]
tests/test_print_preflight.py::test_validate_sign_layout_small_bleed PASSED [ 57%]
tests/test_print_preflight.py::test_validate_sign_layout_warnings PASSED [ 57%]
tests/test_print_skus.py::test_yard_sign_skus PASSED                     [ 58%]
tests/test_print_skus.py::test_smart_sign_skus PASSED                    [ 58%]
tests/test_print_skus.py::test_smart_riser_skus PASSED                   [ 59%]
tests/test_print_skus.py::test_get_price_id_uses_cache_in_test_mode PASSED [ 59%]
tests/test_printing_atomic.py::test_claim_jobs_success FAILED            [ 60%]
tests/test_printing_atomic.py::test_claim_unauthorized PASSED            [ 60%]
tests/test_printing_atomic.py::test_mark_downloaded_transition PASSED    [ 61%]
tests/test_printing_atomic.py::test_download_pdf PASSED                  [ 61%]
tests/test_pro_features.py::TestLeadSubmissionCSRF::test_lead_submission_no_csrf_error PASSED [ 62%]
tests/test_pro_features.py::TestFreeTierLeadLimit::test_free_lead_limit_constant PASSED [ 62%]
tests/test_pro_features.py::TestCSVExport::test_csv_export_requires_login PASSED [ 63%]
tests/test_pro_features.py::TestCSVExport::test_csv_export_route_exists PASSED [ 63%]
tests/test_pro_features.py::TestAnalyticsService::test_analytics_module_exists PASSED [ 64%]
tests/test_pro_features.py::TestAnalyticsService::test_analytics_returns_expected_keys FAILED [ 64%]
tests/test_property_creation_flow.py::TestPropertyCreationFlow::test_get_submit_page_property_only_mode FAILED [ 65%]
tests/test_property_creation_flow.py::TestPropertyCreationFlow::test_create_property_only_does_not_create_order FAILED [ 65%]
tests/test_property_creation_flow.py::TestPropertyCreationFlow::test_standard_flow_creates_order FAILED [ 66%]
tests/test_qr_code_uniqueness.py::TestQRCodeUniqueness::test_is_code_taken_finds_sign_assets PASSED [ 67%]
tests/test_qr_code_uniqueness.py::TestQRCodeUniqueness::test_is_code_taken_finds_properties_qr_code PASSED [ 67%]
tests/test_qr_code_uniqueness.py::TestQRCodeUniqueness::test_is_code_taken_finds_qr_variants PASSED [ 68%]
tests/test_qr_code_uniqueness.py::TestQRCodeUniqueness::test_generate_unique_code_avoids_collisions PASSED [ 68%]
tests/test_qr_code_uniqueness.py::TestOptionBEnforcement::test_create_asset_always_unactivated PASSED [ 69%]
tests/test_qr_code_uniqueness.py::TestOptionBEnforcement::test_activate_asset_requires_order_id PASSED [ 69%]
tests/test_qr_code_uniqueness.py::TestOptionBEnforcement::test_activate_asset_rejects_already_activated PASSED [ 70%]
tests/test_qr_logo_pro_gating.py::test_qr_logo_gating_free_user FAILED   [ 70%]
tests/test_qr_logo_pro_gating.py::test_qr_logo_flow_pro_user FAILED      [ 71%]
tests/test_qr_logo_rendering.py::test_qr_without_logo PASSED             [ 71%]
tests/test_qr_logo_rendering.py::test_qr_with_logo_decodes PASSED        [ 72%]
tests/test_qr_logo_rendering.py::test_qr_auto_fallback PASSED            [ 72%]
tests/test_qr_routes.py::TestPropertyPage::test_paid_property_returns_200 PASSED [ 73%]
tests/test_qr_routes.py::TestPropertyPage::test_expired_property_returns_410 FAILED [ 73%]
tests/test_qr_routes.py::TestPropertyPage::test_invalid_slug_returns_404 PASSED [ 74%]
tests/test_qr_routes.py::TestPropertyPage::test_free_property_returns_200 PASSED [ 74%]
tests/test_qr_routes.py::TestQRRedirect::test_valid_code_redirects PASSED [ 75%]
tests/test_qr_routes.py::TestQRRedirect::test_expired_property_code_returns_410 FAILED [ 75%]
tests/test_qr_routes.py::TestQRRedirect::test_invalid_code_returns_404 PASSED [ 76%]
tests/test_qr_routes.py::TestQRRedirect::test_scan_logs_to_qr_scans PASSED [ 76%]
tests/test_qr_scaling.py::test_qr_integer_scaling PASSED                 [ 77%]
tests/test_release_gate.py::test_release_gate_fails_on_forbidden FAILED  [ 77%]
tests/test_release_gate.py::test_font_registration PASSED                [ 78%]
tests/test_repro_500.py::test_dashboard_new_property_page_loads FAILED   [ 78%]
tests/test_smart_sign_activation.py::TestSmartSignActivation::test_inactive_asset_scan_returns_not_activated_page PASSED [ 79%]
tests/test_smart_sign_activation.py::TestSmartSignActivation::test_active_asset_scan_redirects_to_property PASSED [ 79%]
tests/test_smart_sign_activation.py::TestSmartSignActivation::test_active_unassigned_asset_shows_unassigned_page PASSED [ 80%]
tests/test_smart_sign_activation.py::TestSmartSignActivation::test_assignment_blocked_for_inactive_asset PASSED [ 80%]
tests/test_smart_sign_activation.py::TestSmartSignActivation::test_unassigned_active_asset_scan_logs_to_app_events PASSED [ 81%]
tests/test_smart_signs.py::TestSmartSigns::test_pro_create_asset_via_purchase_flow PASSED [ 81%]
tests/test_smart_signs.py::TestSmartSigns::test_pro_assign_asset_to_own_property FAILED [ 82%]
tests/test_smart_signs.py::TestSmartSigns::test_free_can_initial_assign_asset FAILED [ 82%]
tests/test_smart_signs.py::TestSmartSigns::test_free_cannot_reassign_asset FAILED [ 83%]
tests/test_smart_signs.py::TestSmartSigns::test_free_cannot_unassign_asset FAILED [ 83%]
tests/test_smart_signs.py::TestSmartSigns::test_frozen_blocks_assign FAILED [ 84%]
tests/test_smart_signs.py::TestSmartSigns::test_inactive_blocks_assign PASSED [ 84%]
tests/test_smart_signs.py::TestSmartSigns::test_scan_resolution_flow FAILED [ 85%]
tests/test_smart_signs.py::TestSmartSigns::test_unassigned_asset_page FAILED [ 85%]
tests/test_smart_signs_printing.py::TestSmartSignsPrinting::test_frozen_asset_access FAILED [ 86%]
tests/test_smart_signs_printing.py::TestSmartSignsPrinting::test_non_pro_access FAILED [ 86%]
tests/test_smart_signs_printing.py::TestSmartSignsPrinting::test_pro_active_flow FAILED [ 87%]
tests/test_smartsign_v2_persistence.py::test_smartsign_v2_persistence_e2e FAILED [ 87%]
tests/test_smartsign_validation.py::test_v2_validation PASSED            [ 88%]
tests/test_smoke.py::test_healthz PASSED                                 [ 88%]
tests/test_smoke.py::test_homepage PASSED                                [ 89%]
tests/test_smoke.py::test_qr_generation PASSED                           [ 89%]
tests/test_smoke.py::test_smartsign_pdf_generation PASSED                [ 90%]
tests/test_strategy_alignment.py::test_listing_kit_persistence PASSED    [ 90%]
tests/test_strategy_alignment.py::test_paid_statuses_completeness PASSED [ 91%]
tests/test_strategy_alignment.py::test_webhook_freeze_logic_uses_constants PASSED [ 91%]
tests/test_strategy_alignment.py::test_smart_sign_strictness PASSED      [ 92%]
tests/test_stripe_price_resolver.py::test_resolve_price_id_calls_fail_if_no_cache_and_no_patch FAILED [ 92%]
tests/test_stripe_price_resolver.py::test_resolve_uses_injected_cache PASSED [ 93%]
tests/test_stripe_price_resolver.py::test_warm_cache_forbidden_in_test FAILED [ 93%]
tests/test_stripe_price_resolver.py::test_warm_cache_success PASSED      [ 94%]
tests/test_stripe_price_resolver.py::test_validation_inactive_product PASSED [ 94%]
tests/test_stripe_price_resolver.py::test_validation_duplicate_prices PASSED [ 95%]
tests/test_stripe_price_resolver.py::test_validation_missing_key PASSED  [ 95%]
tests/test_tour_scheduling.py::test_tour_scheduling_link_render FAILED   [ 96%]
tests/test_tour_scheduling.py::test_free_tier_hides_virtual_tour FAILED  [ 96%]
tests/test_webhook_amounts.py::test_webhook_captures_totals FAILED       [ 97%]
tests/test_yard_sign_pdf.py::TestListingSignPDF::test_generate_yard_sign_pdf_queries_schema_correctly SKIPPED [ 97%]
tests/test_yard_sign_pdf.py::TestListingSignPDF::test_yard_sign_qr_value_is_r_path PASSED [ 98%]
tests/test_yard_sign_pdf.py::TestListingSignPDF::test_landscape_layout_used_for_36x24 FAILED [ 98%]
tests/test_yard_sign_pdf.py::TestListingSignPDF::test_standard_layout_used_for_18x24 SKIPPED [ 99%]
tests/test_yard_sign_pdf.py::TestListingSignPDF::test_generate_yard_sign_pdf_smoke PASSED [100%]

==================================== ERRORS ====================================
_________________ ERROR at setup of test_metrics_data_display __________________
tests/test_admin_metrics.py:15: in admin_user
    admin_id = db.execute(
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "users_email_key"
E   DETAIL:  Key (email)=(admin@metrics.test) already exists.
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: duplicate key value violates unique constraint "users_email_key"
DETAIL:  Key (email)=(admin@metrics.test) already exists.

ERROR    database:database.py:52 [DB] SQL: INSERT INTO users (email, password_hash, is_verified, is_admin) VALUES (%s, %s, %s, %s) RETURNING id
____________________ ERROR at setup of test_open_house_mode ____________________
tests/test_feature_flows.py:17: in feature_data
    db.execute("DO $$ DECLARE u_id INT; BEGIN SELECT id INTO u_id FROM users WHERE email = 'owner@feature.com'; IF u_id IS NOT NULL THEN DELETE FROM print_jobs WHERE order_id IN (SELECT id FROM orders WHERE user_id = u_id); DELETE FROM sign_assets WHERE user_id = u_id; DELETE FROM leads WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM campaigns WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM orders WHERE user_id = u_id; DELETE FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id); DELETE FROM agents WHERE user_id = u_id; DELETE FROM users WHERE id = u_id; END IF; END $$;")
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.ForeignKeyViolation: update or delete on table "qr_variants" violates foreign key constraint "fk_qr_scans_qr_variant_id" on table "qr_scans"
E   DETAIL:  Key (id)=(1) is still referenced from table "qr_scans".
E   CONTEXT:  SQL statement "DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id))"
E   PL/pgSQL function inline_code_block line 1 at SQL statement
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: update or delete on table "qr_variants" violates foreign key constraint "fk_qr_scans_qr_variant_id" on table "qr_scans"
DETAIL:  Key (id)=(1) is still referenced from table "qr_scans".
CONTEXT:  SQL statement "DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id))"
PL/pgSQL function inline_code_block line 1 at SQL statement

ERROR    database:database.py:52 [DB] SQL: DO $$ DECLARE u_id INT; BEGIN SELECT id INTO u_id FROM users WHERE email = 'owner@feature.com'; IF u_id IS NOT NULL THEN DELETE FROM print_jobs WHERE order_id IN (SELECT id FROM orders WHERE user_id = u_id); DELETE FROM sign_assets WHERE user_id = u_id; DELETE FROM leads WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM campaigns WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM orders WHERE user_id = u_id; DELETE FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id); DELETE FROM agents WHERE user_id = u_id; DELETE FROM users WHERE id = u_id; END IF; END $$;
___________________ ERROR at setup of test_gating_rendering ____________________
tests/test_feature_flows.py:17: in feature_data
    db.execute("DO $$ DECLARE u_id INT; BEGIN SELECT id INTO u_id FROM users WHERE email = 'owner@feature.com'; IF u_id IS NOT NULL THEN DELETE FROM print_jobs WHERE order_id IN (SELECT id FROM orders WHERE user_id = u_id); DELETE FROM sign_assets WHERE user_id = u_id; DELETE FROM leads WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM campaigns WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM orders WHERE user_id = u_id; DELETE FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id); DELETE FROM agents WHERE user_id = u_id; DELETE FROM users WHERE id = u_id; END IF; END $$;")
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.ForeignKeyViolation: update or delete on table "qr_variants" violates foreign key constraint "fk_qr_scans_qr_variant_id" on table "qr_scans"
E   DETAIL:  Key (id)=(1) is still referenced from table "qr_scans".
E   CONTEXT:  SQL statement "DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id))"
E   PL/pgSQL function inline_code_block line 1 at SQL statement
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: update or delete on table "qr_variants" violates foreign key constraint "fk_qr_scans_qr_variant_id" on table "qr_scans"
DETAIL:  Key (id)=(1) is still referenced from table "qr_scans".
CONTEXT:  SQL statement "DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id))"
PL/pgSQL function inline_code_block line 1 at SQL statement

ERROR    database:database.py:52 [DB] SQL: DO $$ DECLARE u_id INT; BEGIN SELECT id INTO u_id FROM users WHERE email = 'owner@feature.com'; IF u_id IS NOT NULL THEN DELETE FROM print_jobs WHERE order_id IN (SELECT id FROM orders WHERE user_id = u_id); DELETE FROM sign_assets WHERE user_id = u_id; DELETE FROM leads WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM qr_variants WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM campaigns WHERE property_id IN (SELECT id FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id)); DELETE FROM orders WHERE user_id = u_id; DELETE FROM properties WHERE agent_id IN (SELECT id FROM agents WHERE user_id = u_id); DELETE FROM agents WHERE user_id = u_id; DELETE FROM users WHERE id = u_id; END IF; END $$;
___________________ ERROR at setup of test_new_property_get ____________________
file /app/tests/test_free_property.py, line 14
  def test_new_property_get(client, auth):
E       fixture 'auth' not found
>       available fixtures: app, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, class_mocker, client, cov, create_test_user, db, db_session, doctest_namespace, mock_db_cursor, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, requests_mock, session_mocker, subtests, test_user_password, test_user_password_hash, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/test_free_property.py:14
_______________ ERROR at setup of test_new_property_post_success _______________
file /app/tests/test_free_property.py, line 21
  def test_new_property_post_success(client, auth, mock_db_cursor, mocker):
E       fixture 'auth' not found
>       available fixtures: app, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, class_mocker, client, cov, create_test_user, db, db_session, doctest_namespace, mock_db_cursor, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, requests_mock, session_mocker, subtests, test_user_password, test_user_password_hash, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/test_free_property.py:21
_____________ ERROR at setup of test_new_property_post_free_limit ______________
file /app/tests/test_free_property.py, line 73
  def test_new_property_post_free_limit(client, auth, mock_db_cursor, mocker):
E       fixture 'auth' not found
>       available fixtures: app, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, class_mocker, client, cov, create_test_user, db, db_session, doctest_namespace, mock_db_cursor, mocker, module_mocker, monkeypatch, no_cover, package_mocker, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, requests_mock, session_mocker, subtests, test_user_password, test_user_password_hash, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/test_free_property.py:73
__ ERROR at setup of TestPhase1Dashboard.test_dashboard_mode_needs_assignment __
tests/test_onboarding_activation.py:203: in test_user_with_unassigned_sign
    sr = db.execute("INSERT INTO sign_assets (user_id, code, label, activated_at, order_id) VALUES (%s, 'TEST_S1', 'S1', NOW(), %s) RETURNING id", (ur['id'], od['id'])).fetchone()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UndefinedColumn: column "order_id" of relation "sign_assets" does not exist
E   LINE 1: ... sign_assets (user_id, code, label, activated_at, order_id) ...
E                                                                ^
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: column "order_id" of relation "sign_assets" does not exist
LINE 1: ... sign_assets (user_id, code, label, activated_at, order_id) ...
                                                             ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO sign_assets (user_id, code, label, activated_at, order_id) VALUES (%s, 'TEST_S1', 'S1', NOW(), %s) RETURNING id
_______ ERROR at setup of TestPhase1Dashboard.test_dashboard_mode_active _______
tests/test_onboarding_activation.py:221: in test_user_with_assigned_sign
    sr = db.execute("INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id", (ur['id'], pr['id'], od['id'])).fetchone()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UndefinedColumn: column "order_id" of relation "sign_assets" does not exist
E   LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
E                                                                ^
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: column "order_id" of relation "sign_assets" does not exist
LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
                                                             ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id
_________ ERROR at setup of TestPhase1Dashboard.test_first_scan_banner _________
tests/test_onboarding_activation.py:221: in test_user_with_assigned_sign
    sr = db.execute("INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id", (ur['id'], pr['id'], od['id'])).fetchone()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UndefinedColumn: column "order_id" of relation "sign_assets" does not exist
E   LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
E                                                                ^
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: column "order_id" of relation "sign_assets" does not exist
LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
                                                             ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id
_________ ERROR at setup of TestPhase1Dashboard.test_first_lead_banner _________
tests/test_onboarding_activation.py:221: in test_user_with_assigned_sign
    sr = db.execute("INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id", (ur['id'], pr['id'], od['id'])).fetchone()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UndefinedColumn: column "order_id" of relation "sign_assets" does not exist
E   LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
E                                                                ^
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: column "order_id" of relation "sign_assets" does not exist
LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
                                                             ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id
____ ERROR at setup of TestPhase1Dashboard.test_analytics_gated_until_scan _____
tests/test_onboarding_activation.py:221: in test_user_with_assigned_sign
    sr = db.execute("INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id", (ur['id'], pr['id'], od['id'])).fetchone()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UndefinedColumn: column "order_id" of relation "sign_assets" does not exist
E   LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
E                                                                ^
------------------------------ Captured log setup ------------------------------
ERROR    database:database.py:50 [DB] Query Failed: column "order_id" of relation "sign_assets" does not exist
LINE 1: ...d, code, label, activated_at, active_property_id, order_id) ...
                                                             ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO sign_assets (user_id, code, label, activated_at, active_property_id, order_id) VALUES (%s, 'TEST_S2', 'S2', NOW(), %s, %s) RETURNING id
=================================== FAILURES ===================================
_____________ test_submit_blocked_when_agent_claimed_by_other_user _____________
tests/test_agent_claiming_security.py:160: in test_submit_blocked_when_agent_claimed_by_other_user
    db.execute("INSERT INTO users (email, password_hash, is_verified) VALUES (%s, %s, %s)", (attacker_email, hashed, True))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "users_email_key"
E   DETAIL:  Key (email)=(attacker@example.com) already exists.
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: duplicate key value violates unique constraint "users_email_key"
DETAIL:  Key (email)=(attacker@example.com) already exists.

ERROR    database:database.py:52 [DB] SQL: INSERT INTO users (email, password_hash, is_verified) VALUES (%s, %s, %s)
_________________ TestAIReadiness.test_agent_action_lifecycle __________________
tests/test_ai_readiness.py:103: in test_agent_action_lifecycle
    self.assertIsNotNone(action.executed_at)
                         ^^^^^^^^^^^^^^^^^^
E   AttributeError: 'AgentAction' object has no attribute 'executed_at'. Did you mean: 'rejected_at'?
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-09T17:17:01.466316", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:01.466987", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:01.467136", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:01.468078", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:01.490955", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log call -------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
_____________ TestConfigStagingBoot.test_staging_boot_without_smtp _____________
tests/test_config_boot.py:51: in test_staging_boot_without_smtp
    assert config.IS_PRODUCTION == True
E   AssertionError: assert False == True
E    +  where False = <module 'config' from '/app/config.py'>.IS_PRODUCTION

During handling of the above exception, another exception occurred:
tests/test_config_boot.py:55: in test_staging_boot_without_smtp
    pytest.fail(f"Config raised exception: {e}")
E   Failed: Config raised exception: assert False == True
E    +  where False = <module 'config' from '/app/config.py'>.IS_PRODUCTION
_____________________________ test_lead_lifecycle ______________________________
tests/test_feature_flows.py:70: in test_lead_lifecycle
    assert f"/dashboard/leads/{lead_id}" in response.location
E   AssertionError: assert '/dashboard/leads/1' in '/login?next=%2Fapi%2Fleads%2F1%2Fnotes'
E    +  where '/login?next=%2Fapi%2Fleads%2F1%2Fnotes' = <WrapperTestResponse streamed [302 FOUND]>.location
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-09T17:17:02.046566", "level": "INFO", "message": "[Leads] New lead 1 for property 3", "logger": "app", "module": "leads", "lineno": 220, "method": "POST", "path": "/api/leads/submit", "remote_ip": "127.0.0.1", "request_id": "e15d3337-5595-4d6b-a62d-fcc962e0d624"}
------------------------------ Captured log call -------------------------------
INFO     app:leads.py:220 [Leads] New lead 1 for property 3
__________________ test_fulfill_order_enqueues_one_print_job ___________________
tests/test_fulfillment.py:48: in test_fulfill_order_enqueues_one_print_job
    assert ok1 is True
E   assert False is True
------------------------------ Captured log call -------------------------------
ERROR    services.fulfillment:fulfillment.py:89 [Fulfillment] Order 2 has no paid_at timestamp - cannot fulfill
________________________ test_fulfill_order_idempotency ________________________
tests/test_fulfillment.py:103: in test_fulfill_order_idempotency
    assert result is True
E   assert False is True
------------------------------ Captured log call -------------------------------
ERROR    services.fulfillment:fulfillment.py:89 [Fulfillment] Order 3 has no paid_at timestamp - cannot fulfill
_________________ test_property_creation_uses_global_generator _________________
tests/test_global_code_generation_enforcement.py:76: in test_property_creation_uses_global_generator
    assert resp.status_code in (200, 302)
E   assert 403 in (200, 302)
E    +  where 403 = <WrapperTestResponse streamed [403 FORBIDDEN]>.status_code
_________________ test_variant_creation_uses_global_generator __________________
tests/test_global_code_generation_enforcement.py:111: in test_variant_creation_uses_global_generator
    'campaign_id': campaign['id'],
                   ^^^^^^^^^^^^^^
E   TypeError: 'NoneType' object is not subscriptable
_________________________ test_guest_linking_security __________________________
tests/test_guest_linking_security.py:30: in test_guest_linking_security
    db.execute(
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.UndefinedColumn: column "request_id" of relation "orders" does not exist
E   LINE 1: INSERT INTO orders (request_id, guest_email, guest_token, st...
E                               ^
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2026-02-09T17:17:03.473385", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:03.474131", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:03.474289", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:03.475261", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:03.499499", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log setup ------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: column "request_id" of relation "orders" does not exist
LINE 1: INSERT INTO orders (request_id, guest_email, guest_token, st...
                            ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO orders (request_id, guest_email, guest_token, status, order_type) VALUES (%s, %s, %s, 'pending', 'sign')
______________________ test_guest_resize_with_body_token _______________________
tests/test_guest_security.py:9: in test_guest_resize_with_body_token
    patch('routes.orders.get_agent_data_for_order'), \
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1497: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1467: in get_original
    raise AttributeError(
E   AttributeError: <module 'routes.orders' from '/app/routes/orders.py'> does not have the attribute 'get_agent_data_for_order'
________________________ test_billing_unverified_access ________________________
tests/test_guest_security.py:46: in test_billing_unverified_access
    resp = client.post('/order-sign', json={'property_id': 1})
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/testing.py:235: in open
    response = super().open(
/usr/local/lib/python3.13/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
routes/orders.py:145: in order_sign
    order = Order.get(row['id'])
            ^^^^^^^^^^^^^^^^^^^^
models.py:112: in get
    row = db.execute("SELECT * FROM orders WHERE id = %s", (order_id,)).fetchone()
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.ProgrammingError: can't adapt type 'MagicMock'
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: can't adapt type 'MagicMock'
ERROR    database:database.py:52 [DB] SQL: SELECT * FROM orders WHERE id = %s
_________________ TestLeadValidation.test_lead_with_phone_only _________________
tests/test_lead_attribution.py:138: in test_lead_with_phone_only
    assert response.status_code == 200
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2026-02-09T17:17:04.768882", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:04.769744", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:04.769926", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:04.771003", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:04.790295", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log setup ------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-09T17:17:04.847354", "level": "ERROR", "message": "[Leads] Error saving lead: null value in column \"buyer_email\" of relation \"leads\" violates not-null constraint\nDETAIL:  Failing row contains (3, 1, 1, Interested Buyer, null, 555-123-4567, call, null, null, t, new, 127.0.0.1, 2026-02-09 17:17:04.837066, null, null, direct).\n", "logger": "app", "module": "leads", "lineno": 286, "method": "POST", "path": "/api/leads/submit", "remote_ip": "127.0.0.1", "request_id": "03da1355-822b-4960-8e4c-070432880569"}
{"timestamp": "2026-02-09T17:17:04.848797", "level": "WARNING", "message": "[Events] Failed to track lead_submitted: current transaction is aborted, commands ignored until end of transaction block\n", "logger": "app", "module": "events", "lineno": 196, "method": "POST", "path": "/api/leads/submit", "remote_ip": "127.0.0.1", "request_id": "03da1355-822b-4960-8e4c-070432880569"}
------------------------------ Captured log call -------------------------------
ERROR    app:leads.py:286 [Leads] Error saving lead: null value in column "buyer_email" of relation "leads" violates not-null constraint
DETAIL:  Failing row contains (3, 1, 1, Interested Buyer, null, 555-123-4567, call, null, null, t, new, 127.0.0.1, 2026-02-09 17:17:04.837066, null, null, direct).

ERROR    database:database.py:50 [DB] Query Failed: current transaction is aborted, commands ignored until end of transaction block

ERROR    database:database.py:52 [DB] SQL: INSERT INTO app_events (event_type, source, schema_version, environment, actor_type, actor_id, subject_type, subject_id, user_id, property_id, sign_asset_id, order_id, qr_code, session_id, request_id, idempotency_key, ip_hash, ua_hash, payload) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s) RETURNING id
WARNING  app:events.py:196 [Events] Failed to track lead_submitted: current transaction is aborted, commands ignored until end of transaction block
________________ TestLeadAttribution.test_forged_token_ignored _________________
tests/test_lead_attribution.py:302: in test_forged_token_ignored
    client.set_cookie('localhost', 'smart_attrib', '999.12345.forgedsig0000000000000')
E   TypeError: Client.set_cookie() takes from 2 to 3 positional arguments but 4 were given
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2026-02-09T17:17:05.131631", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:05.132242", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:05.132368", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:05.133163", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:05.151342", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log setup ------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
________________________ test_kit_zip_builder_structure ________________________
tests/test_listing_kits_imports.py:41: in test_kit_zip_builder_structure
    generate_kit(1)
services/listing_kits.py:72: in generate_kit
    db.execute("UPDATE listing_kits SET status='failed', last_error='Property not found' WHERE id=%s", (kit_id,))
/usr/local/lib/python3.13/unittest/mock.py:1169: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1173: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1230: in _execute_mock_call
    result = next(effect)
             ^^^^^^^^^^^^
E   StopIteration
__________ TestLocalStorageSecurity.test_get_url_returns_storage_path __________
tests/test_local_storage_security.py:74: in test_get_url_returns_storage_path
    assert "/storage/" in url
E   AssertionError: assert '/storage/' in '/uploads/test.jpg'
_______________ TestPhase1Dashboard.test_dashboard_mode_no_signs _______________
tests/test_onboarding_activation.py:31: in test_dashboard_mode_no_signs
    assert 'Get your first buyer lead' in html
E   assert 'Get your first buyer lead' in '<!doctype html>\n<html lang=en>\n<title>Redirecting...</title>\n<h1>Redirecting...</h1>\n<p>You should be redirected automatically to the target URL: <a href="/verify">/verify</a>. If not, click the link.\n'
___________________ test_pdf_with_agent_photo_has_one_image ____________________
tests/test_pdf_vector_qr.py:140: in test_pdf_with_agent_photo_has_one_image
    assert total_images == 1, (
E   AssertionError: Expected 1 image (agent photo), got 0. QR should be vector, not adding to image count.
E   assert 0 == 1
------------------------------ Captured log call -------------------------------
ERROR    utils.pdf_generator:pdf_generator.py:291 QR Draw Error: draw_qr() got multiple values for argument 'size'
ERROR    utils.pdf_generator:pdf_generator.py:291 QR Draw Error: draw_qr() got multiple values for argument 'size'
_________________ test_free_user_cannot_create_second_property _________________
tests/test_phase4_guardrails.py:86: in test_free_user_cannot_create_second_property
    assert resp.status_code == 402
E   assert 403 == 402
E    +  where 403 = <WrapperTestResponse streamed [403 FORBIDDEN]>.status_code
_________________ test_pro_user_can_create_multiple_properties _________________
tests/test_phase4_guardrails.py:114: in test_pro_user_can_create_multiple_properties
    assert resp.status_code in (200, 302, 303)
E   assert 403 in (200, 302, 303)
E    +  where 403 = <WrapperTestResponse streamed [403 FORBIDDEN]>.status_code
__________________________ test_reassign_requires_pro __________________________
tests/test_phase4_guardrails.py:144: in test_reassign_requires_pro
    asset = _create_test_asset(db, phase4_data['free_id'], activated=True, frozen=False)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_phase4_guardrails.py:131: in _create_test_asset
    db.execute(
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (4, 36, vHsZWfNuqF0H, null, null, 2026-02-09 17:17:06.051968, null, f, 2026-02-09 17:17:06.051968, 2026-02-09 17:17:06.051968, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (4, 36, vHsZWfNuqF0H, null, null, 2026-02-09 17:17:06.051968, null, f, 2026-02-09 17:17:06.051968, 2026-02-09 17:17:06.051968, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: INSERT INTO sign_assets (user_id, code, active_property_id, is_frozen, activated_at) 
           VALUES (%s, %s, %s, %s, %s) RETURNING id
_______________________ test_reassign_requires_activated _______________________
tests/test_phase4_guardrails.py:192: in test_reassign_requires_activated
    assert b'activated' in follow_resp.data.lower()
E   assert b'activated' in b'<!doctype html>\n<html lang="en">\n\n<head>\n    <meta charset="utf-8">\n    <title>qr real estate signs</title>\n    <link rel="stylesheet" href="/static/css/style.css?v=9">\n    <link rel="stylesheet" href="/static/css/components.css">\n    <meta name="viewport" content="width=device-width, initial-scale=1">\n</head>\n\n<body class="auth-page">\n    <!-- navigation -->\n    <nav class="navbar" style="z-index: 1000;">\n        <!-- left: logo & hamburger -->\n        <div style="display: flex; align-items: center; gap: 16px;">\n            <button class="hamburger-btn" aria-label="menu" onclick="toggledrawer()">\n                <svg viewbox="0 0 24 24" width="24" height="24" stroke="rgba(255,255,255,0.9)" stroke-width="2"\n                    fill="none">\n                    <path d="m3 12h18m3 6h18m3 18h18" />\n                </svg>\n            </button>\n\n        </div>\n\n        <!-- center: desktop links -->\n        <div class="nav-center desktop-only">\n            \n            \n            <!-- links removed by user request -->\n            \n            \n        </div>\n\n        <!-- right: auth buttons -->\n        <div class="nav-right flex-center gap-md">\...">\n\n            <label style="color: #666; font-size: 0.9rem; margin-bottom: 5px; display: block;">password</label>\n            <input type="password" name="password" required placeholder="\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2">\n\n            <button type="submit" class="glass-button accent auth-btn" id="login-btn"\n                style="width: 100%; text-align: center; margin-top: 1rem;">\n                login\n            </button>\n        </form>\n\n        <script>\n            document.getelementbyid(\'login-form\').addeventlistener(\'submit\', function (e) {\n                const btn = document.getelementbyid(\'login-btn\');\n                btn.disabled = true;\n                btn.innerhtml = \'logging in...\';\n                btn.style.opacity = \'0.7\';\n                btn.style.cursor = \'not-allowed\';\n            });\n        </script>\n        <p style="text-align: center; margin-top: 1rem; color: #fff;">\n            don\'t have an account? <a href="/register?next=/dashboard/"\n                style="color: #4facfe;">register</a>\n        </p>\n    </div>\n</div>\n\n    </div>\n</body>\n\n</html>'
E    +  where b'<!doctype html>\n<html lang="en">\n\n<head>\n    <meta charset="utf-8">\n    <title>qr real estate signs</title>\n    <link rel="stylesheet" href="/static/css/style.css?v=9">\n    <link rel="stylesheet" href="/static/css/components.css">\n    <meta name="viewport" content="width=device-width, initial-scale=1">\n</head>\n\n<body class="auth-page">\n    <!-- navigation -->\n    <nav class="navbar" style="z-index: 1000;">\n        <!-- left: logo & hamburger -->\n        <div style="display: flex; align-items: center; gap: 16px;">\n            <button class="hamburger-btn" aria-label="menu" onclick="toggledrawer()">\n                <svg viewbox="0 0 24 24" width="24" height="24" stroke="rgba(255,255,255,0.9)" stroke-width="2"\n                    fill="none">\n                    <path d="m3 12h18m3 6h18m3 18h18" />\n                </svg>\n            </button>\n\n        </div>\n\n        <!-- center: desktop links -->\n        <div class="nav-center desktop-only">\n            \n            \n            <!-- links removed by user request -->\n            \n            \n        </div>\n\n        <!-- right: auth buttons -->\n        <div class="nav-right flex-center gap-md">\...">\n\n            <label style="color: #666; font-size: 0.9rem; margin-bottom: 5px; display: block;">password</label>\n            <input type="password" name="password" required placeholder="\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2">\n\n            <button type="submit" class="glass-button accent auth-btn" id="login-btn"\n                style="width: 100%; text-align: center; margin-top: 1rem;">\n                login\n            </button>\n        </form>\n\n        <script>\n            document.getelementbyid(\'login-form\').addeventlistener(\'submit\', function (e) {\n                const btn = document.getelementbyid(\'login-btn\');\n                btn.disabled = true;\n                btn.innerhtml = \'logging in...\';\n                btn.style.opacity = \'0.7\';\n                btn.style.cursor = \'not-allowed\';\n            });\n        </script>\n        <p style="text-align: center; margin-top: 1rem; color: #fff;">\n            don\'t have an account? <a href="/register?next=/dashboard/"\n                style="color: #4facfe;">register</a>\n        </p>\n    </div>\n</div>\n\n    </div>\n</body>\n\n</html>' = <built-in method lower of bytes object at 0x561ece81d740>()
E    +    where <built-in method lower of bytes object at 0x561ece81d740> = b'<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <title>QR Real Estate Signs</title>\n    <link rel="stylesheet" href="/static/css/style.css?v=9">\n    <link rel="stylesheet" href="/static/css/components.css">\n    <meta name="viewport" content="width=device-width, initial-scale=1">\n</head>\n\n<body class="auth-page">\n    <!-- Navigation -->\n    <nav class="navbar" style="z-index: 1000;">\n        <!-- Left: Logo & Hamburger -->\n        <div style="display: flex; align-items: center; gap: 16px;">\n            <button class="hamburger-btn" aria-label="Menu" onclick="toggleDrawer()">\n                <svg viewBox="0 0 24 24" width="24" height="24" stroke="rgba(255,255,255,0.9)" stroke-width="2"\n                    fill="none">\n                    <path d="M3 12h18M3 6h18M3 18h18" />\n                </svg>\n            </button>\n\n        </div>\n\n        <!-- Center: Desktop Links -->\n        <div class="nav-center desktop-only">\n            \n            \n            <!-- Links removed by user request -->\n            \n            \n        </div>\n\n        <!-- Right: Auth Buttons -->\n        <div class="nav-right flex-center gap-md">\...">\n\n            <label style="color: #666; font-size: 0.9rem; margin-bottom: 5px; display: block;">Password</label>\n            <input type="password" name="password" required placeholder="\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2">\n\n            <button type="submit" class="glass-button accent auth-btn" id="login-btn"\n                style="width: 100%; text-align: center; margin-top: 1rem;">\n                Login\n            </button>\n        </form>\n\n        <script>\n            document.getElementById(\'login-form\').addEventListener(\'submit\', function (e) {\n                const btn = document.getElementById(\'login-btn\');\n                btn.disabled = true;\n                btn.innerHTML = \'Logging in...\';\n                btn.style.opacity = \'0.7\';\n                btn.style.cursor = \'not-allowed\';\n            });\n        </script>\n        <p style="text-align: center; margin-top: 1rem; color: #fff;">\n            Don\'t have an account? <a href="/register?next=/dashboard/"\n                style="color: #4facfe;">Register</a>\n        </p>\n    </div>\n</div>\n\n    </div>\n</body>\n\n</html>'.lower
E    +      where b'<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <title>QR Real Estate Signs</title>\n    <link rel="stylesheet" href="/static/css/style.css?v=9">\n    <link rel="stylesheet" href="/static/css/components.css">\n    <meta name="viewport" content="width=device-width, initial-scale=1">\n</head>\n\n<body class="auth-page">\n    <!-- Navigation -->\n    <nav class="navbar" style="z-index: 1000;">\n        <!-- Left: Logo & Hamburger -->\n        <div style="display: flex; align-items: center; gap: 16px;">\n            <button class="hamburger-btn" aria-label="Menu" onclick="toggleDrawer()">\n                <svg viewBox="0 0 24 24" width="24" height="24" stroke="rgba(255,255,255,0.9)" stroke-width="2"\n                    fill="none">\n                    <path d="M3 12h18M3 6h18M3 18h18" />\n                </svg>\n            </button>\n\n        </div>\n\n        <!-- Center: Desktop Links -->\n        <div class="nav-center desktop-only">\n            \n            \n            <!-- Links removed by user request -->\n            \n            \n        </div>\n\n        <!-- Right: Auth Buttons -->\n        <div class="nav-right flex-center gap-md">\...">\n\n            <label style="color: #666; font-size: 0.9rem; margin-bottom: 5px; display: block;">Password</label>\n            <input type="password" name="password" required placeholder="\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2\xe2\x80\xa2">\n\n            <button type="submit" class="glass-button accent auth-btn" id="login-btn"\n                style="width: 100%; text-align: center; margin-top: 1rem;">\n                Login\n            </button>\n        </form>\n\n        <script>\n            document.getElementById(\'login-form\').addEventListener(\'submit\', function (e) {\n                const btn = document.getElementById(\'login-btn\');\n                btn.disabled = true;\n                btn.innerHTML = \'Logging in...\';\n                btn.style.opacity = \'0.7\';\n                btn.style.cursor = \'not-allowed\';\n            });\n        </script>\n        <p style="text-align: center; margin-top: 1rem; color: #fff;">\n            Don\'t have an account? <a href="/register?next=/dashboard/"\n                style="color: #4facfe;">Register</a>\n        </p>\n    </div>\n</div>\n\n    </div>\n</body>\n\n</html>' = <WrapperTestResponse 5656 bytes [200 OK]>.data
______________________ test_reassign_blocked_when_frozen _______________________
tests/test_phase4_guardrails.py:198: in test_reassign_blocked_when_frozen
    asset = _create_test_asset(db, phase4_data['pro_id'], activated=True, frozen=True)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_phase4_guardrails.py:131: in _create_test_asset
    db.execute(
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (6, 39, lgpxHO6thrxs, null, null, 2026-02-09 17:17:06.298446, null, t, 2026-02-09 17:17:06.298446, 2026-02-09 17:17:06.298446, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (6, 39, lgpxHO6thrxs, null, null, 2026-02-09 17:17:06.298446, null, t, 2026-02-09 17:17:06.298446, 2026-02-09 17:17:06.298446, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: INSERT INTO sign_assets (user_id, code, active_property_id, is_frozen, activated_at) 
           VALUES (%s, %s, %s, %s, %s) RETURNING id
_____________________ test_listing_kit_returns_reason_code _____________________
tests/test_phase4_guardrails.py:248: in test_listing_kit_returns_reason_code
    assert resp.status_code == 200
E   assert 302 == 200
E    +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
_____________________ test_webhook_idempotency_activation ______________________
tests/test_phase_2_5.py:98: in test_webhook_idempotency_activation
    with patch('routes.webhook.fulfill_order', return_value=True) as mock_fulfill:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1497: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1467: in get_original
    raise AttributeError(
E   AttributeError: <module 'routes.webhook' from '/app/routes/webhook.py'> does not have the attribute 'fulfill_order'
____________________________ test_assignment_rules _____________________________
tests/test_phase_2_5.py:160: in test_assignment_rules
    db.execute("UPDATE sign_assets SET activated_at = CURRENT_TIMESTAMP WHERE id=%s", (asset_id,))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (8, 43, CJQWEZDMF8AC, Rule Test, 18, 2026-02-09 17:17:06.708173, null, f, 2026-02-09 17:17:06.703269, 2026-02-09 17:17:06.703269, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (8, 43, CJQWEZDMF8AC, Rule Test, 18, 2026-02-09 17:17:06.708173, null, f, 2026-02-09 17:17:06.703269, 2026-02-09 17:17:06.703269, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at = CURRENT_TIMESTAMP WHERE id=%s
__________________ test_smart_sign_checkout_endpoint_disabled __________________
tests/test_phase_2_5.py:180: in test_smart_sign_checkout_endpoint_disabled
    assert resp.status_code == 404
E   assert 302 == 404
E    +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
___________________________ test_claim_jobs_success ____________________________
tests/test_printing_atomic.py:58: in test_claim_jobs_success
    assert job['job_id'] == atomic_data['job_id']
E   AssertionError: assert 'job_pdf' == 'job-123'
E     
E     - job-123
E     + job_pdf
__________ TestAnalyticsService.test_analytics_returns_expected_keys ___________
tests/test_pro_features.py:91: in test_analytics_returns_expected_keys
    self.assertIn('scans', result)
E   AssertionError: 'scans' not found in {}
_______ TestPropertyCreationFlow.test_get_submit_page_property_only_mode _______
tests/test_property_creation_flow.py:31: in test_get_submit_page_property_only_mode
    resp = client.get(url_for('agent.submit', mode='property_only'))
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/helpers.py:239: in url_for
    return current_app.url_for(
/usr/local/lib/python3.13/site-packages/flask/app.py:1090: in url_for
    raise RuntimeError(
E   RuntimeError: Unable to build URLs outside an active request without 'SERVER_NAME' configured. Also configure 'APPLICATION_ROOT' and 'PREFERRED_URL_SCHEME' as needed.
___ TestPropertyCreationFlow.test_create_property_only_does_not_create_order ___
tests/test_property_creation_flow.py:69: in test_create_property_only_does_not_create_order
    resp = client.post(url_for('agent.submit'), data=data, follow_redirects=True)
                       ^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/helpers.py:239: in url_for
    return current_app.url_for(
/usr/local/lib/python3.13/site-packages/flask/app.py:1090: in url_for
    raise RuntimeError(
E   RuntimeError: Unable to build URLs outside an active request without 'SERVER_NAME' configured. Also configure 'APPLICATION_ROOT' and 'PREFERRED_URL_SCHEME' as needed.
__________ TestPropertyCreationFlow.test_standard_flow_creates_order ___________
tests/test_property_creation_flow.py:122: in test_standard_flow_creates_order
    resp = client.post(url_for('agent.submit'), data=data, follow_redirects=True)
                       ^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/site-packages/flask/helpers.py:239: in url_for
    return current_app.url_for(
/usr/local/lib/python3.13/site-packages/flask/app.py:1090: in url_for
    raise RuntimeError(
E   RuntimeError: Unable to build URLs outside an active request without 'SERVER_NAME' configured. Also configure 'APPLICATION_ROOT' and 'PREFERRED_URL_SCHEME' as needed.
________________________ test_qr_logo_gating_free_user _________________________
tests/test_qr_logo_pro_gating.py:53: in test_qr_logo_gating_free_user
    assert resp.status_code == 403
E   assert 302 == 403
E    +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
__________________________ test_qr_logo_flow_pro_user __________________________
tests/test_qr_logo_pro_gating.py:81: in test_qr_logo_flow_pro_user
    assert resp.status_code == 200, f"Response: {resp.text}"
E   AssertionError: Response: <!doctype html>
E     <html lang=en>
E     <title>Redirecting...</title>
E     <h1>Redirecting...</h1>
E     <p>You should be redirected automatically to the target URL: <a href="/login?next=%2Fapi%2Fbranding%2Fqr-logo">/login?next=%2Fapi%2Fbranding%2Fqr-logo</a>. If not, click the link.
E     
E   assert 302 == 200
E    +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
______________ TestPropertyPage.test_expired_property_returns_410 ______________
tests/test_qr_routes.py:106: in test_expired_property_returns_410
    assert response.status_code == 410
E   assert 200 == 410
E    +  where 200 = <WrapperTestResponse streamed [200 OK]>.status_code
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2026-02-09T17:17:08.685728", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:08.686350", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:08.686477", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:08.687348", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:08.713587", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log setup ------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
____________ TestQRRedirect.test_expired_property_code_returns_410 _____________
tests/test_qr_routes.py:133: in test_expired_property_code_returns_410
    assert response.status_code == 410
E   assert 302 == 410
E    +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2026-02-09T17:17:09.059060", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:09.059704", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:09.059839", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:09.060765", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:09.078458", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log setup ------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
_____________________ test_release_gate_fails_on_forbidden _____________________
tests/test_release_gate.py:19: in test_release_gate_fails_on_forbidden
    assert "CRITICAL FAILURE" in result.stdout
E   AssertionError: assert 'CRITICAL FAILURE' in '[Release Gate] Running safety checks...\n[Release Gate] Running acceptance tests...\n[Acceptance] Building web with dev deps...\n[Release Gate] FAILED: Acceptance tests did not pass.\n'
E    +  where '[Release Gate] Running safety checks...\n[Release Gate] Running acceptance tests...\n[Acceptance] Building web with dev deps...\n[Release Gate] FAILED: Acceptance tests did not pass.\n' = CompletedProcess(args=['/usr/local/bin/python', 'scripts/release_gate.py'], returncode=1, stdout='[Release Gate] Running safety checks...\n[Release Gate] Running acceptance tests...\n[Acceptance] Building web with dev deps...\n[Release Gate] FAILED: Acceptance tests did not pass.\n', stderr='/app/scripts/run_tests_in_docker.sh: line 27: docker: command not found\n').stdout
____________________ test_dashboard_new_property_page_loads ____________________
tests/test_repro_500.py:34: in test_dashboard_new_property_page_loads
    db.execute(
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.SyntaxError: INSERT has more target columns than expressions
E   LINE 1: INSERT INTO agents (user_id, name, email, brokerage) VALUES ...
E                                                     ^
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: INSERT has more target columns than expressions
LINE 1: INSERT INTO agents (user_id, name, email, brokerage) VALUES ...
                                                  ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO agents (user_id, name, email, brokerage) VALUES (%s, %s, %s)
_____________ TestSmartSigns.test_pro_assign_asset_to_own_property _____________
tests/test_smart_signs.py:47: in test_pro_assign_asset_to_own_property
    asset = self._create_active_asset(db, user_id, "My Sign")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_smart_signs.py:10: in _create_active_asset
    db.execute("UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s", (asset['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (20, 74, N32ZEMCWSB8U, My Sign, null, 2026-02-09 17:17:09.777359, null, f, 2026-02-09 17:17:09.773678, 2026-02-09 17:17:09.773678, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (20, 74, N32ZEMCWSB8U, My Sign, null, 2026-02-09 17:17:09.777359, null, f, 2026-02-09 17:17:09.773678, 2026-02-09 17:17:09.773678, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s
______________ TestSmartSigns.test_free_can_initial_assign_asset _______________
tests/test_smart_signs.py:65: in test_free_can_initial_assign_asset
    asset = self._create_active_asset(db, user_id, "Free Initial Sign")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_smart_signs.py:10: in _create_active_asset
    db.execute("UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s", (asset['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (21, 75, 54QXGFQDD5E2, Free Initial Sign, null, 2026-02-09 17:17:09.833527, null, f, 2026-02-09 17:17:09.826348, 2026-02-09 17:17:09.826348, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (21, 75, 54QXGFQDD5E2, Free Initial Sign, null, 2026-02-09 17:17:09.833527, null, f, 2026-02-09 17:17:09.826348, 2026-02-09 17:17:09.826348, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s
________________ TestSmartSigns.test_free_cannot_reassign_asset ________________
tests/test_smart_signs.py:95: in test_free_cannot_reassign_asset
    asset = self._create_active_asset(db, user_id, "Reassign Sign")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_smart_signs.py:10: in _create_active_asset
    db.execute("UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s", (asset['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (22, 76, 3L9NX26PNB2H, Reassign Sign, null, 2026-02-09 17:17:09.889315, null, f, 2026-02-09 17:17:09.885082, 2026-02-09 17:17:09.885082, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (22, 76, 3L9NX26PNB2H, Reassign Sign, null, 2026-02-09 17:17:09.889315, null, f, 2026-02-09 17:17:09.885082, 2026-02-09 17:17:09.885082, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s
________________ TestSmartSigns.test_free_cannot_unassign_asset ________________
tests/test_smart_signs.py:124: in test_free_cannot_unassign_asset
    asset = self._create_active_asset(db, user_id, "Unassign Sign")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_smart_signs.py:10: in _create_active_asset
    db.execute("UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s", (asset['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (23, 77, NJUE8EBB833J, Unassign Sign, null, 2026-02-09 17:17:09.943506, null, f, 2026-02-09 17:17:09.939297, 2026-02-09 17:17:09.939297, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (23, 77, NJUE8EBB833J, Unassign Sign, null, 2026-02-09 17:17:09.943506, null, f, 2026-02-09 17:17:09.939297, 2026-02-09 17:17:09.939297, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s
___________________ TestSmartSigns.test_frozen_blocks_assign ___________________
tests/test_smart_signs.py:144: in test_frozen_blocks_assign
    asset = self._create_active_asset(db, user_id, "Frozen Sign")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_smart_signs.py:10: in _create_active_asset
    db.execute("UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s", (asset['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (24, 78, PE8LJ7SKH82P, Frozen Sign, null, 2026-02-09 17:17:10.000233, null, f, 2026-02-09 17:17:09.992605, 2026-02-09 17:17:09.992605, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (24, 78, PE8LJ7SKH82P, Frozen Sign, null, 2026-02-09 17:17:10.000233, null, f, 2026-02-09 17:17:09.992605, 2026-02-09 17:17:09.992605, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s
___________________ TestSmartSigns.test_scan_resolution_flow ___________________
tests/test_smart_signs.py:171: in test_scan_resolution_flow
    asset = self._create_active_asset(db, user_id, "Scan Me")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_smart_signs.py:10: in _create_active_asset
    db.execute("UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s", (asset['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (26, 80, F4T9TQ93DTJF, Scan Me, null, 2026-02-09 17:17:10.071683, null, f, 2026-02-09 17:17:10.064321, 2026-02-09 17:17:10.064321, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (26, 80, F4T9TQ93DTJF, Scan Me, null, 2026-02-09 17:17:10.071683, null, f, 2026-02-09 17:17:10.064321, 2026-02-09 17:17:10.064321, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s
__________________ TestSmartSigns.test_unassigned_asset_page ___________________
tests/test_smart_signs.py:198: in test_unassigned_asset_page
    asset = self._create_active_asset(db, user_id, "Lone Wolf")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_smart_signs.py:10: in _create_active_asset
    db.execute("UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s", (asset['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.CheckViolation: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
E   DETAIL:  Failing row contains (27, 81, E38XSR8DVLUC, Lone Wolf, null, 2026-02-09 17:17:10.123447, null, f, 2026-02-09 17:17:10.116612, 2026-02-09 17:17:10.116612, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: new row for relation "sign_assets" violates check constraint "chk_activation_requires_order"
DETAIL:  Failing row contains (27, 81, E38XSR8DVLUC, Lone Wolf, null, 2026-02-09 17:17:10.123447, null, f, 2026-02-09 17:17:10.116612, 2026-02-09 17:17:10.116612, null, null, null, scan_for_details, solid_blue, null, null, t, f, null, null, null, null, auto, null).

ERROR    database:database.py:52 [DB] SQL: UPDATE sign_assets SET activated_at=now(), is_frozen=false WHERE id=%s
_______________ TestSmartSignsPrinting.test_frozen_asset_access ________________
tests/test_smart_signs_printing.py:19: in setUp
    db.execute("DELETE FROM users WHERE email IN ('pro@test.com', 'basic@test.com')")
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.ForeignKeyViolation: update or delete on table "users" violates foreign key constraint "agents_user_id_fkey" on table "agents"
E   DETAIL:  Key (id)=(43) is still referenced from table "agents".
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-09T17:17:10.165681", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:10.166352", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:10.166488", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:10.167556", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:10.191561", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log call -------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
ERROR    database:database.py:50 [DB] Query Failed: update or delete on table "users" violates foreign key constraint "agents_user_id_fkey" on table "agents"
DETAIL:  Key (id)=(43) is still referenced from table "agents".

ERROR    database:database.py:52 [DB] SQL: DELETE FROM users WHERE email IN ('pro@test.com', 'basic@test.com')
__________________ TestSmartSignsPrinting.test_non_pro_access __________________
tests/test_smart_signs_printing.py:19: in setUp
    db.execute("DELETE FROM users WHERE email IN ('pro@test.com', 'basic@test.com')")
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.ForeignKeyViolation: update or delete on table "users" violates foreign key constraint "agents_user_id_fkey" on table "agents"
E   DETAIL:  Key (id)=(43) is still referenced from table "agents".
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-09T17:17:10.261345", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:10.261989", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:10.262121", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:10.262990", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:10.289621", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log call -------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
ERROR    database:database.py:50 [DB] Query Failed: update or delete on table "users" violates foreign key constraint "agents_user_id_fkey" on table "agents"
DETAIL:  Key (id)=(43) is still referenced from table "agents".

ERROR    database:database.py:52 [DB] SQL: DELETE FROM users WHERE email IN ('pro@test.com', 'basic@test.com')
_________________ TestSmartSignsPrinting.test_pro_active_flow __________________
tests/test_smart_signs_printing.py:19: in setUp
    db.execute("DELETE FROM users WHERE email IN ('pro@test.com', 'basic@test.com')")
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.ForeignKeyViolation: update or delete on table "users" violates foreign key constraint "agents_user_id_fkey" on table "agents"
E   DETAIL:  Key (id)=(43) is still referenced from table "agents".
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-09T17:17:10.360402", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:10.360996", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:10.361119", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:10.361983", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:10.388020", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log call -------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
ERROR    database:database.py:50 [DB] Query Failed: update or delete on table "users" violates foreign key constraint "agents_user_id_fkey" on table "agents"
DETAIL:  Key (id)=(43) is still referenced from table "agents".

ERROR    database:database.py:52 [DB] SQL: DELETE FROM users WHERE email IN ('pro@test.com', 'basic@test.com')
______________________ test_smartsign_v2_persistence_e2e _______________________
tests/test_smartsign_v2_persistence.py:102: in test_smartsign_v2_persistence_e2e
    generate_smartsign_pdf(asset_dict, order_id)
services/pdf_smartsign.py:441: in generate_smartsign_pdf
    _draw_smart_v2_vertical_banner(c, layout, asset, user_id, active_base_url)
services/pdf_smartsign.py:1000: in _draw_smart_v2_vertical_banner
    safe_margin = to_pt(spec.get('safe_margin_in', 0.5))
                        ^^^^^^^^
E   AttributeError: 'NoneType' object has no attribute 'get'
__________ test_resolve_price_id_calls_fail_if_no_cache_and_no_patch ___________
tests/test_stripe_price_resolver.py:22: in test_resolve_price_id_calls_fail_if_no_cache_and_no_patch
    resolve_price_id("missing_key")
services/stripe_price_resolver.py:69: in resolve_price_id
    _refresh_keys([lookup_key])
services/stripe_price_resolver.py:122: in _refresh_keys
    resp = stripe.Price.list(
/usr/local/lib/python3.13/unittest/mock.py:1169: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1173: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1228: in _execute_mock_call
    raise effect
E   RuntimeError: NETWORK CALL

During handling of the above exception, another exception occurred:
tests/test_stripe_price_resolver.py:21: in test_resolve_price_id_calls_fail_if_no_cache_and_no_patch
    with pytest.raises(RuntimeError, match="Stripe network call attempted in TEST mode"):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AssertionError: Regex pattern did not match.
E     Expected regex: 'Stripe network call attempted in TEST mode'
E     Actual message: 'NETWORK CALL'
------------------------------ Captured log call -------------------------------
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['missing_key']: NETWORK CALL
______________________ test_warm_cache_forbidden_in_test _______________________
tests/test_stripe_price_resolver.py:38: in test_warm_cache_forbidden_in_test
    warm_cache(['k1'])
services/stripe_price_resolver.py:103: in warm_cache
    _refresh_keys(chunk)
services/stripe_price_resolver.py:122: in _refresh_keys
    resp = stripe.Price.list(
/usr/local/lib/python3.13/unittest/mock.py:1169: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1173: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1228: in _execute_mock_call
    raise effect
E   RuntimeError: NETWORK CALL

During handling of the above exception, another exception occurred:
tests/test_stripe_price_resolver.py:37: in test_warm_cache_forbidden_in_test
    with pytest.raises(RuntimeError, match="warm_cache called in TEST mode"):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AssertionError: Regex pattern did not match.
E     Expected regex: 'warm_cache called in TEST mode'
E     Actual message: 'NETWORK CALL'
------------------------------ Captured log call -------------------------------
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['k1']: NETWORK CALL
_______________________ test_tour_scheduling_link_render _______________________
tests/test_tour_scheduling.py:30: in test_tour_scheduling_link_render
    db.execute(
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.NotNullViolation: null value in column "brokerage" of relation "agents" violates not-null constraint
E   DETAIL:  Failing row contains (53, 83, Test Agent, null, agent@test.com, null, null, null, https://calendly.com/test, null, null).
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2026-02-09T17:17:11.084442", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:11.085083", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:11.085297", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:11.086206", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:11.106651", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log setup ------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: null value in column "brokerage" of relation "agents" violates not-null constraint
DETAIL:  Failing row contains (53, 83, Test Agent, null, agent@test.com, null, null, null, https://calendly.com/test, null, null).

ERROR    database:database.py:52 [DB] SQL: INSERT INTO agents (user_id, name, email, scheduling_url) VALUES (%s, 'Test Agent', 'agent@test.com', 'https://calendly.com/test')
______________________ test_free_tier_hides_virtual_tour _______________________
tests/test_tour_scheduling.py:65: in test_free_tier_hides_virtual_tour
    db.execute("INSERT INTO agents (user_id, name, email, brokerage) VALUES (%s, 'Free Agent', 'free@test.com')", (user['id'],))
database.py:53: in execute
    raise e
database.py:45: in execute
    cur.execute(sql, params)
/usr/local/lib/python3.13/site-packages/psycopg2/extras.py:146: in execute
    return super().execute(query, vars)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   psycopg2.errors.SyntaxError: INSERT has more target columns than expressions
E   LINE 1: INSERT INTO agents (user_id, name, email, brokerage) VALUES ...
E                                                     ^
---------------------------- Captured stdout setup -----------------------------
{"timestamp": "2026-02-09T17:17:11.179314", "level": "INFO", "message": "[App] create_app() called", "logger": "app", "module": "app", "lineno": 29}
{"timestamp": "2026-02-09T17:17:11.180052", "level": "INFO", "message": "[App] Flask app instance created", "logger": "app", "module": "app", "lineno": 31}
{"timestamp": "2026-02-09T17:17:11.180219", "level": "INFO", "message": "Logger setup complete. JSON formatted logs enabled.", "logger": "app", "module": "logger", "lineno": 66}
{"timestamp": "2026-02-09T17:17:11.181120", "level": "INFO", "message": "[Startup] Warming Stripe Price Cache...", "logger": "app", "module": "app", "lineno": 112}
{"timestamp": "2026-02-09T17:17:11.205194", "level": "WARNING", "message": "[Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock", "logger": "app", "module": "app", "lineno": 120}
------------------------------ Captured log setup ------------------------------
INFO     app:app.py:29 [App] create_app() called
INFO     app:app.py:31 [App] Flask app instance created
INFO     app:logger.py:66 Logger setup complete. JSON formatted logs enabled.
INFO     app:app.py:112 [Startup] Warming Stripe Price Cache...
ERROR    services.stripe_price_resolver:stripe_price_resolver.py:129 Stripe API error refreshing keys ['smart_sign_print_18x24', 'smart_sign_print_24x36', 'smart_sign_print_36x24', 'smart_riser_6x24', 'smart_riser_6x36', 'yard_sign_coroplast_12x18', 'yard_sign_coroplast_18x24', 'yard_sign_coroplast_24x36', 'yard_sign_aluminum_18x24', 'yard_sign_aluminum_24x36']: Invalid API Key provided: sk_test_mock
WARNING  app:app.py:120 [Startup] Dev Warning: Cache warm failed: Invalid API Key provided: sk_test_mock
------------------------------ Captured log call -------------------------------
ERROR    database:database.py:50 [DB] Query Failed: INSERT has more target columns than expressions
LINE 1: INSERT INTO agents (user_id, name, email, brokerage) VALUES ...
                                                  ^

ERROR    database:database.py:52 [DB] SQL: INSERT INTO agents (user_id, name, email, brokerage) VALUES (%s, 'Free Agent', 'free@test.com')
_________________________ test_webhook_captures_totals _________________________
tests/test_webhook_amounts.py:44: in test_webhook_captures_totals
    with patch('routes.webhook.fulfill_order', return_value=True) as mock_fulfill:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1497: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.13/unittest/mock.py:1467: in get_original
    raise AttributeError(
E   AttributeError: <module 'routes.webhook' from '/app/routes/webhook.py'> does not have the attribute 'fulfill_order'
___________ TestListingSignPDF.test_landscape_layout_used_for_36x24 ____________
tests/test_yard_sign_pdf.py:188: in test_landscape_layout_used_for_36x24
    assert len(landscape_called) > 0, "Landscape layout should be called for 36x24"
E   AssertionError: Landscape layout should be called for 36x24
E   assert 0 > 0
E    +  where 0 = len([])
=============================== warnings summary ===============================
utils/logger.py:16: 3 warnings
tests/test_ai_readiness.py: 26 warnings
tests/test_feature_flows.py: 1 warning
tests/test_guest_linking_security.py: 5 warnings
tests/test_lead_attribution.py: 38 warnings
tests/test_pro_features.py: 1 warning
tests/test_qr_routes.py: 40 warnings
tests/test_smart_signs_printing.py: 15 warnings
tests/test_strategy_alignment.py: 5 warnings
tests/test_tour_scheduling.py: 10 warnings
  /app/utils/logger.py:16: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

tests/test_ai_readiness.py::TestAIReadiness::test_agent_action_lifecycle
  /app/services/agent_actions.py:85: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    action.approved_at = datetime.utcnow() # timezone naive? Models usually want tz aware or we convert.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_agent_claiming_security.py::test_submit_blocked_when_agent_claimed_by_other_user
FAILED tests/test_ai_readiness.py::TestAIReadiness::test_agent_action_lifecycle
FAILED tests/test_config_boot.py::TestConfigStagingBoot::test_staging_boot_without_smtp
FAILED tests/test_feature_flows.py::test_lead_lifecycle - AssertionError: ass...
FAILED tests/test_fulfillment.py::test_fulfill_order_enqueues_one_print_job
FAILED tests/test_fulfillment.py::test_fulfill_order_idempotency - assert Fal...
FAILED tests/test_global_code_generation_enforcement.py::test_property_creation_uses_global_generator
FAILED tests/test_global_code_generation_enforcement.py::test_variant_creation_uses_global_generator
FAILED tests/test_guest_linking_security.py::test_guest_linking_security - ps...
FAILED tests/test_guest_security.py::test_guest_resize_with_body_token - Attr...
FAILED tests/test_guest_security.py::test_billing_unverified_access - psycopg...
FAILED tests/test_lead_attribution.py::TestLeadValidation::test_lead_with_phone_only
FAILED tests/test_lead_attribution.py::TestLeadAttribution::test_forged_token_ignored
FAILED tests/test_listing_kits_imports.py::test_kit_zip_builder_structure - S...
FAILED tests/test_local_storage_security.py::TestLocalStorageSecurity::test_get_url_returns_storage_path
FAILED tests/test_onboarding_activation.py::TestPhase1Dashboard::test_dashboard_mode_no_signs
FAILED tests/test_pdf_vector_qr.py::test_pdf_with_agent_photo_has_one_image
FAILED tests/test_phase4_guardrails.py::test_free_user_cannot_create_second_property
FAILED tests/test_phase4_guardrails.py::test_pro_user_can_create_multiple_properties
FAILED tests/test_phase4_guardrails.py::test_reassign_requires_pro - psycopg2...
FAILED tests/test_phase4_guardrails.py::test_reassign_requires_activated - as...
FAILED tests/test_phase4_guardrails.py::test_reassign_blocked_when_frozen - p...
FAILED tests/test_phase4_guardrails.py::test_listing_kit_returns_reason_code
FAILED tests/test_phase_2_5.py::test_webhook_idempotency_activation - Attribu...
FAILED tests/test_phase_2_5.py::test_assignment_rules - psycopg2.errors.Check...
FAILED tests/test_phase_2_5.py::test_smart_sign_checkout_endpoint_disabled - ...
FAILED tests/test_printing_atomic.py::test_claim_jobs_success - AssertionErro...
FAILED tests/test_pro_features.py::TestAnalyticsService::test_analytics_returns_expected_keys
FAILED tests/test_property_creation_flow.py::TestPropertyCreationFlow::test_get_submit_page_property_only_mode
FAILED tests/test_property_creation_flow.py::TestPropertyCreationFlow::test_create_property_only_does_not_create_order
FAILED tests/test_property_creation_flow.py::TestPropertyCreationFlow::test_standard_flow_creates_order
FAILED tests/test_qr_logo_pro_gating.py::test_qr_logo_gating_free_user - asse...
FAILED tests/test_qr_logo_pro_gating.py::test_qr_logo_flow_pro_user - Asserti...
FAILED tests/test_qr_routes.py::TestPropertyPage::test_expired_property_returns_410
FAILED tests/test_qr_routes.py::TestQRRedirect::test_expired_property_code_returns_410
FAILED tests/test_release_gate.py::test_release_gate_fails_on_forbidden - Ass...
FAILED tests/test_repro_500.py::test_dashboard_new_property_page_loads - psyc...
FAILED tests/test_smart_signs.py::TestSmartSigns::test_pro_assign_asset_to_own_property
FAILED tests/test_smart_signs.py::TestSmartSigns::test_free_can_initial_assign_asset
FAILED tests/test_smart_signs.py::TestSmartSigns::test_free_cannot_reassign_asset
FAILED tests/test_smart_signs.py::TestSmartSigns::test_free_cannot_unassign_asset
FAILED tests/test_smart_signs.py::TestSmartSigns::test_frozen_blocks_assign
FAILED tests/test_smart_signs.py::TestSmartSigns::test_scan_resolution_flow
FAILED tests/test_smart_signs.py::TestSmartSigns::test_unassigned_asset_page
FAILED tests/test_smart_signs_printing.py::TestSmartSignsPrinting::test_frozen_asset_access
FAILED tests/test_smart_signs_printing.py::TestSmartSignsPrinting::test_non_pro_access
FAILED tests/test_smart_signs_printing.py::TestSmartSignsPrinting::test_pro_active_flow
FAILED tests/test_smartsign_v2_persistence.py::test_smartsign_v2_persistence_e2e
FAILED tests/test_stripe_price_resolver.py::test_resolve_price_id_calls_fail_if_no_cache_and_no_patch
FAILED tests/test_stripe_price_resolver.py::test_warm_cache_forbidden_in_test
FAILED tests/test_tour_scheduling.py::test_tour_scheduling_link_render - psyc...
FAILED tests/test_tour_scheduling.py::test_free_tier_hides_virtual_tour - psy...
FAILED tests/test_webhook_amounts.py::test_webhook_captures_totals - Attribut...
FAILED tests/test_yard_sign_pdf.py::TestListingSignPDF::test_landscape_layout_used_for_36x24
ERROR tests/test_admin_metrics.py::test_metrics_data_display - psycopg2.error...
ERROR tests/test_feature_flows.py::test_open_house_mode - psycopg2.errors.For...
ERROR tests/test_feature_flows.py::test_gating_rendering - psycopg2.errors.Fo...
ERROR tests/test_free_property.py::test_new_property_get
ERROR tests/test_free_property.py::test_new_property_post_success
ERROR tests/test_free_property.py::test_new_property_post_free_limit
ERROR tests/test_onboarding_activation.py::TestPhase1Dashboard::test_dashboard_mode_needs_assignment
ERROR tests/test_onboarding_activation.py::TestPhase1Dashboard::test_dashboard_mode_active
ERROR tests/test_onboarding_activation.py::TestPhase1Dashboard::test_first_scan_banner
ERROR tests/test_onboarding_activation.py::TestPhase1Dashboard::test_first_lead_banner
ERROR tests/test_onboarding_activation.py::TestPhase1Dashboard::test_analytics_gated_until_scan
===== 54 failed, 126 passed, 6 skipped, 145 warnings, 11 errors in 16.94s ======
